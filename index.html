<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<title>Moxie Books â€¢ ç¦»çº¿å°å†Œï¼ˆv1.3 SafeButtonsï¼‰</title>
<style>
:root{
  --bg:#fff;
  --fg:#222;
  --muted:#666;
  --primary:#ff7aa8; /* ç²‰ */
  --card:#ffffff;
  --card-border:#eee;
  --chip-bg:#ffe5ef;
  --chip-fg:#b03b66;
  --shadow:0 6px 20px rgba(0,0,0,.06);
  --radius:14px;
}
html,body{height:100%;}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,BlinkMacSystemFont,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;}
/* é¡¶æ  */
.header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:5}
.header .row{display:flex;align-items:center;gap:10px;padding:10px 12px;max-width:980px;margin:0 auto;}
.header .title{font-weight:700;font-size:18px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.btn{appearance:none;border:1px solid var(--card-border);background:#fff;padding:8px 12px;border-radius:999px;box-shadow:var(--shadow);cursor:pointer;}
.iconbtn{border:none;background:transparent;padding:8px;border-radius:10px;}
.badge{font-size:12px;color:#fff;background:var(--primary);padding:2px 8px;border-radius:999px;margin-left:6px}
/* ä¹¦æ¶ç½‘æ ¼ */
.container{max-width:980px;margin:0 auto;padding:12px;display:block}
.grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px}
@media(min-width:700px){.grid{grid-template-columns:repeat(3, minmax(0,1fr));}}
/* æ­£æ–‡å­—å—èƒŒæ™¯ */
.rich-editor {
  background: rgba(255,255,255,0.6);
  border-radius: 12px;
  padding: 10px;
}
/* â­ è¢«ç½®é¡¶çš„æ ‡ç­¾æ ·å¼ï¼ˆå»æ‰æ˜Ÿå·ï¼‰ */
.tag-pinned {
  position: relative;
  background: #ffeef5 !important;
  border-color: #ff84b3 !important;
  color: #ff5c9a !important;
}
.tag-pinned::after {
  content: none !important;
}
/* åªéšè—æ ‡ç­¾æ¡ä¸Šçš„é‚£é¢—â­ï¼Œç¼©ç•¥å›¾ä¸Šçš„æ˜Ÿæ˜Ÿä¸åŠ¨ */
#tagBar .star {
  display: none !important;
}

/* â­ æ–°å¢ï¼šä¸“é—¨ç»™â€œé¡µç¼©ç•¥å›¾â€ç”¨çš„ç¼©æ”¾ç½‘æ ¼ï¼Œæ”¯æŒ æ›´å°/ è¶…å° /å° / ä¸­ / å¤§ */
.grid.thumb-grid{grid-template-columns:repeat(2, minmax(0,1fr));}

/* å°ï¼šä¸€æ¬¡å¤šæ”¾å‡ å¼ ï¼ˆ3åˆ—ï¼‰ */
.grid.thumb-grid.thumb-s{
  grid-template-columns:repeat(3, minmax(0,1fr)) !important;
}

/* ä¸­ï¼šé»˜è®¤ï¼ˆ2åˆ—ï¼‰ */
.grid.thumb-grid.thumb-m{
  grid-template-columns:repeat(2, minmax(0,1fr)) !important;
}

/* å¤§ï¼šä¸€åˆ—å¤§å¡ç‰‡ */
.grid.thumb-grid.thumb-l{
  grid-template-columns:repeat(1, minmax(0,1fr)) !important;
}
/* 4 åˆ—ï¼šè¶…å°å¡ç‰‡ */
.grid.thumb-grid.thumb-4c{
  grid-template-columns:repeat(4, minmax(0,1fr)) !important;
}

/* 5 åˆ—ï¼šæ›´å°ï¼Œä¸€å±å¡æ›´å¤š */
.grid.thumb-grid.thumb-5c{
  grid-template-columns:repeat(5, minmax(0,1fr)) !important;
}

.card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;min-height:160px;}
.card .cover{aspect-ratio:16/10;background:#f6f6f6 center/cover no-repeat;position:relative}
.card .cover .label{position:absolute;left:8px;bottom:8px;background:rgba(0,0,0,.55);color:#fff;font-size:12px;padding:2px 6px;border-radius:999px}
.card .cover .card-menu-btn{
  position:absolute;
  top:8px;
  right:8px;
  background:rgba(0,0,0,.55);
  color:#fff;
  border:none;
  border-radius:999px;
  padding:2px 8px;
  font-size:14px;
  cursor:pointer;
}
.card .body{padding:10px 12px}
.card .name{font-weight:700}
.card .sub{color:var(--muted);font-size:12px;margin-top:4px}
.row{display:flex;gap:8px;align-items:center}
.spacer{flex:1}
/* é¡µç¼©ç•¥å›¾ç½‘æ ¼ */
.thumb .img.font-thumb{display:flex;align-items:center;justify-content:center;}
.thumb .img.font-thumb .font-sample{font-size:20px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.thumb{border-radius:10px;border:1px solid var(--card-border);overflow:hidden;background:#fafafa;position:relative}
.thumb .img{aspect-ratio:1/1;background:#eee center/cover no-repeat}
.thumb .meta{padding:8px 10px}
.star{position:absolute;right:8px;top:8px;background:rgba(255,255,255,.8);border:1px solid var(--card-border);border-radius:999px;padding:6px;box-shadow:var(--shadow)}
.star.on{background:gold;border-color:#e0c000}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.chip{background:var(--chip-bg);color:var(--chip-fg);border-radius:999px;padding:2px 8px;font-size:12px}
/* æ ‡ç­¾ç­›é€‰æ¡ï¼šé¡¶éƒ¨é‚£ä¸€æ’å¯å·¦å³æ»‘åŠ¨çš„å°æŒ‰é’® */
.tag-row{
  margin-bottom:8px;
  overflow-x:auto;
  flex-wrap:nowrap;
}
.tag-row::-webkit-scrollbar{display:none;}

.tag-btn{
  white-space:nowrap;
  font-size:12px;
  padding:4px 10px;
}

/* è¢«é€‰ä¸­çš„æ ‡ç­¾æŒ‰é’®ç¨å¾®äº®ä¸€ç‚¹ */
.tag-btn.tag-on{
  filter:brightness(1.08);
  box-shadow:0 0 0 1px rgba(0,0,0,.06);
}
/* è¯¦æƒ…é¡µ */
.detail{display:flex;flex-direction:column;gap:10px}
.detail .imgbox{
    background:#000;
    display:flex;
    justify-content:center;
    align-items:center;
    border-radius:12px;
    overflow:hidden;
    position:relative;   /* æ–°å¢è¿™ä¸€è¡Œï¼Œè®©é‡Œé¢çš„ç®­å¤´å¯ä»¥ç»å¯¹å®šä½ */
}
/* æ–‡å­—é¡µ / å›¾æ–‡æ··æ’é¡µï¼šæŠŠä¸Šé¢çš„å¤§å›¾åŒºåŸŸè—æ‰ï¼Œåªç”¨ä¸‹é¢çš„æ­£æ–‡ */
.detail[data-layout="note"] .imgbox,
.detail[data-layout="rich"] .imgbox{
  display:none;
}
.detail img{max-width:100%;height:auto;display:block}
.field{display:flex;flex-direction:column;gap:6px}
.input, textarea{width:100%;padding:10px 12px;border:1px solid var(--card-border);border-radius:10px;background:#fff;box-sizing:border-box}
small.muted{color:var(--muted)}
.toolbar{position:sticky;bottom:10px;display:flex;gap:10px;justify-content:center;margin:10px 0}
/* é»˜è®¤æ˜¾ç¤ºï¼ˆä¸»é¡µç”¨ï¼‰ */
.fab{
  position:fixed;
  right:18px;
  bottom:18px;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:999px;
  width:56px;
  height:56px;
  display:flex;              /* æ”¹å›æ˜¾ç¤º */
  align-items:center;
  justify-content:center;
  font-size:28px;
  box-shadow:var(--shadow);
  cursor:pointer;
  z-index:999;
}

/* è¯¦æƒ…é¡µéšè— */
body.detail .fab{
  display:none !important;
}
.page-nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  width:36px;
  height:36px;
  border-radius:50%;
  border:1px solid var(--card-border);
  background:rgba(255,255,255,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  cursor:pointer;
  box-shadow:var(--shadow);
}
.page-nav.left{ left:8px; }
.page-nav.right{ right:8px; }
.page-nav:disabled{
  opacity:.4;
  cursor:default;
}
/* æœç´¢ç»“æœåˆ—è¡¨ */
.list .item{display:flex;gap:10px;padding:10px;border-bottom:1px solid var(--card-border)}
.item .mini{width:64px;height:64px;background:#eee center/cover no-repeat;border-radius:8px;border:1px solid var(--card-border)}
.item .txt{flex:1}
.item .t{font-weight:700}
.hl{background:linear-gradient(transparent 20%, #fff0a8 20%, #fff0a8 80%, transparent 80%);}
/* ä¸»é¢˜ï¼šç²‰ / è“ / ç™½/ é»‘ */
/* ç²‰Â·æ¢¦ç³– */
.theme-pink {
  --primary:#ff7aa8;
  --bg:#fff;
  --card:#fff;
  --fg:#333;
  --chip-bg:#ffe5ef;
  --chip-fg:#b03b66;
}

/* è“Â·æ¸…é£ */
.theme-blue {
  --primary:#a9d8ff;
  --bg:#fafdff;
  --card:#ffffff;
  --fg:#2b3e57;
  --chip-bg:#e8f4ff;
  --chip-fg:#3a6be0;
}

/* ç™½Â·æç®€ */
.theme-white {
  --primary:#bbb;
  --bg:#ffffff;          /* çœŸÂ·çº¯ç™½åº• */
  --card:#ffffff;
  --fg:#444;
  --chip-bg:#f9f9f9;
  --chip-fg:#666;
}

/* é»‘Â·å¤œå¹• */
.theme-dark {
  --primary:#444;        /* æŒ‰é’®æ·±ç°ï¼Œä¸ç²‰ */
  --bg:transparent;      /* ä¿ç•™åº•å›¾ï¼ä¸è¦é»‘åº• */
  --card:#ffffff;   /* å¡ç‰‡ä¿æŒç™½åº• */
  --fg:#444;
  --chip-bg:#333;
  --chip-fg:#ddd;
}
/* é»‘è‰²ä¸»é¢˜ä¸‹åŠ å·æŒ‰é’®æ”¹ä¸ºçº¯é»‘åº•ç™½å­— */
body.theme-dark .fab {
  background: #000 !important;
  color: #fff !important;
}
/* ç™½è‰²ä¸»é¢˜ä¸‹ï¼šé¡¶æ æŒ‰é’®ä¿æŒç™½è‰²ï¼Œä¸è¦å˜æˆç°å— */
body.theme-white .header .btn {
  background:#fff;
  color:#444;
  border:1px solid var(--card-border);
}

/* è®©ç™½è‰²ä¸»é¢˜çœŸæ­£çº¯ç™½ï¼ŒæŒ‰é’®ä¸ç° */
body.theme-white .header .btn {
  background: #fff !important;
  color: #444 !important;
  border: 1px solid #ddd !important;
}


/* === ç™½è‰²ä¸»é¢˜ä¸‹ï¼ŒåŠ å·æŒ‰é’®æ”¹ä¸ºçº¯ç™½ === */
body.theme-white .fab {
  background: #fff !important;
  color: #222 !important;
  border: 1px solid #ddd !important;
}
body.theme-dark .header .title {
  color: #222 !important;           /* é¡¶éƒ¨æ ‡é¢˜ä¿æŒæ·±è‰² */
}

/* === æœç´¢ç»“æœæ‰€æœ‰æ–‡å­—å¼ºåˆ¶é»‘è‰² === */
#searchResultInline,
#searchResultInline *,
.list .item *,
.list .item .txt,
.list .item .sub {
  color: #000 !important;
}
/* é¡¶æ æŒ‰é’®è‡ªåŠ¨è·Ÿéšä¸»é¢˜è‰² */
.header .btn {
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 6px 12px;
    margin-left: 6px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.header .btn:hover {
    filter: brightness(1.1);
    transform: translateY(-1px);
}


/* å»æ‰ä¸‘çš„â€œè®¾é¦–é¡µèƒŒæ™¯â€ç°æ¡† */
#btnTheme, #btnFav, #btnSearch {
    box-shadow: 0 0 5px rgba(255,255,255,0.3);
}
/* çŠ¶æ€ç‚¹ */
.statusdot{width:10px;height:10px;border-radius:50%;background:#bbb;display:inline-block;margin-left:6px}
.statusdot.ok{background:#16c60c}
/* ç¬”è®°é‡Œçš„å°ç¼©ç•¥å›¾æ ·å¼ */
.thumbnail{
  max-width: 100%;
  height: auto;
  border-radius: 6px;
  cursor: pointer;
}
/* å…¨å±å›¾ç‰‡é¢„è§ˆè’™ç‰ˆ */
.img-preview-mask{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.img-preview-mask img{
  max-width: 96vw;
  max-height: 96vh;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
}

/* é¼ æ ‡/æ‰‹æŒ‡æŒ‰ä½æ—¶å¾®å¾®æ”¾å¤§ä¸€ç‚¹ */
.thumbnail:hover{
  transform: scale(1.05);
  transition: 0.2s;
}
/* å¯Œæ–‡æœ¬å›¾æ–‡æ··æ’ç¼–è¾‘å™¨ */
.rich-editor{
  min-height:60vh;       /* åŸæ¥æ˜¯ 260pxï¼Œæ”¹æˆå å±å¹• 60% é«˜ */
  max-height:none;
  overflow-y:auto;
  word-break:break-word;
  position:relative;
}

/* æ­£æ–‡é‡Œçš„å°å›¾æ ·å¼ï¼ˆé»˜è®¤å½“è´´çº¸ç”¨ï¼‰ */
.inline-img{
  position:relative;   /* â­ è®°å¾—åŠ è¿™ä¸€è¡Œï¼Œè®© left/top ç”Ÿæ•ˆ */
  max-width:100%;
  width:60%;
  height:auto;
  display:block;
  margin:10px auto;
  border-radius:12px;
  cursor:pointer;
}
/* â€”â€” v1.3 é¢å¤–ï¼šé¡¶æ å†…è”é¢æ¿ â€”â€” */
#inlineBars{padding-top:0}
#searchBar,#themeBar{display:none;padding:8px 0}
</style>
</head>
<body>
<div class="header">
<div class="row">
<button class="iconbtn" id="btnBack" style="display:none" title="è¿”å›">âŸµ</button>
<div class="title" id="title">Moxie Books</div>
<!-- æ–°ï¼šå°é½¿è½®æŒ‰é’®ï¼Œåªæ˜¾ç¤ºåœ¨é¡¶æ  -->
<button class="btn" id="btnTools" onclick="toggleTools()">âš™ åŠŸèƒ½</button>
<!-- æ—§çš„å››ä¸ªæŒ‰é’®ä¿ç•™ä½†éšè—ï¼Œåªç»™è„šæœ¬ç”¨ï¼Œä¸å åœ°æ–¹ -->
<button class="btn" id="btnSearch" onclick="onSearchBtn()" style="display:none">ğŸ” æœç´¢</button>
<button class="btn" id="btnFav" onclick="onFavBtn()" style="display:none">â˜… æ”¶è—</button>
<button class="btn" id="btnTheme" onclick="onThemeBtn()" style="display:none">ğŸ¨ ä¸»é¢˜</button>
<button class="btn" id="btnSetHomeBg" style="display:none">ğŸŒˆ è®¾é¦–é¡µèƒŒæ™¯</button>
<span class="statusdot" id="statusDot" title="ä¿å­˜çŠ¶æ€"></span>
</div>
</div>
<!-- æ–°ï¼šé¡¶æ ä¸‹é¢ä¸€æ’å·¥å…·é”®ï¼ˆé»˜è®¤æ”¶èµ·ï¼‰ -->
<div class="container" id="toolsBar" style="display:none">
<div class="row" style="gap:8px; flex-wrap:wrap">
<button class="btn" onclick="onSearchBtn()">ğŸ” æœç´¢</button>
<button class="btn" onclick="onFavBtn()">â˜… æ”¶è—</button>
<button class="btn" onclick="onThemeBtn()">ğŸ¨ ä¸»é¢˜</button>
<button class="btn" onclick="document.getElementById('btnSetHomeBg').click()">ğŸŒˆ è®¾é¦–é¡µèƒŒæ™¯</button>
<!-- GitHub äº‘å¤‡ä»½å…¥å£ï¼šç‚¹å‡»åªæ‰“å¼€ä¸‹é¢é‚£ä¸ªå°é¢æ¿ -->
<button class="btn" onclick="openGithubPanel()">â˜ GitHub å¤‡ä»½</button>
<!-- æœ¬åœ°å¯¼å…¥ / å¯¼å‡º JSON å¤‡ä»½ -->
<button class="btn" onclick="exportBackup()">ğŸ’¾ å¯¼å‡ºåˆ°æ–‡ä»¶</button>
<button class="btn" onclick="importBackup()">ğŸ“¥ ä»æ–‡ä»¶å¯¼å…¥</button>
</div>
</div>
<!-- é¡¶æ ä¸‹çš„å†…è”é¢æ¿ï¼ˆæœç´¢æ¡† & ä¸»é¢˜é€‰æ‹©ï¼‰ -->
<div class="container" id="inlineBars">
<div id="searchBar">
<input class="input" id="searchInputInline" placeholder='æœç´¢æ ‡é¢˜/æ ‡ç­¾/æ­£æ–‡/URLï¼›æ”¯æŒ tag:åœ†ä½“ url:kiwi "æ•´å¥" â˜…'/>
<div class="list" id="searchResultInline"></div>
</div>
<div id="themeBar">
<div class="row">
<button class="btn" data-theme-inline="pink">ç²‰ Â· æ¢¦ç³–</button>
<button class="btn" data-theme-inline="blue">è“ Â· æ¸…é£</button>
<button class="btn" data-theme-inline="white">ç™½ Â· æç®€</button>
<button class="btn" data-theme-inline="dark">é»‘ Â· å¤œå¹•</button>
</div>
</div>
</div>
<!-- GitHub å¤‡ä»½é¢æ¿ -->
<div id="ghPanelMask" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);
            z-index:999;align-items:center;justify-content:center;">
<div style="width:min(92vw,420px);background:#fff;border-radius:16px;
              padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.18);">
<div class="row" style="margin-bottom:10px;">
<div style="font-weight:600;">â˜ GitHub äº‘å¤‡ä»½</div>
<div class="spacer"></div>
<button class="iconbtn" onclick="closeGithubPanel()" type="button">âœ•</button>
</div>
<div class="field">
<label>Token</label>
<input class="input" id="ghToken" placeholder="GitHub Personal Access Token"/>
</div>
<div class="field">
<label>ä»“åº“æ‹¥æœ‰è€…ï¼ˆownerï¼‰</label>
<input class="input" id="ghOwner" placeholder="ä¾‹å¦‚ï¼šQYYaml"/>
</div>
<div class="field">
<label>ä»“åº“åï¼ˆrepoï¼‰</label>
<input class="input" id="ghRepo" placeholder="ä¾‹å¦‚ï¼šmoxie-books-backup"/>
</div>
<div class="field">
<label>æ–‡ä»¶è·¯å¾„ï¼ˆpathï¼‰</label>
<input class="input" id="ghPath" placeholder="ä¾‹å¦‚ï¼šmoxie-diary.json"/>
<small class="muted">ä¸€ä¸ªä»“åº“é‡Œæ”¾ä¸€ä»½æ€»å¤‡ä»½æ–‡ä»¶å°±å¤Ÿäº†ã€‚</small>
</div>
<!-- âœ… è‡ªåŠ¨å¤‡ä»½é¢‘ç‡ï¼šæ³¨æ„å®ƒå¿…é¡»åœ¨è¿™é‡Œï¼Œä¸èƒ½åœ¨ <script> é‡Œ -->
<div class="field">
<label>è‡ªåŠ¨å¤‡ä»½é¢‘ç‡</label>
<select class="input" id="ghInterval" onchange="onGhIntervalChange()">
<option value="10m">æ¯ 10 åˆ†é’Ÿï¼ˆé»˜è®¤ï¼‰</option>
<option value="1h">æ¯ 1 å°æ—¶</option>
<option value="3h">æ¯ 3 å°æ—¶</option>
<option value="1d">æ¯å¤©ä¸€æ¬¡</option>
</select>
</div>
<label style="font-size:13px;display:flex;align-items:center;gap:6px;
                  margin:8px 0 12px;">
<input id="ghAuto" onchange="onGhAutoChange()" type="checkbox"/>
      è‡ªåŠ¨åœ¨ä½ ç¼–è¾‘åéš”ä¸€æ®µæ—¶é—´å¤‡ä»½åˆ° GitHub
    </label>
<div class="row" style="justify-content:flex-end;margin-top:10px;gap:8px;">
<button class="btn" onclick="ghRestoreBackup()" type="button">â¬‡ ä» GitHub æ¢å¤</button>
<button class="btn" onclick="ghUploadBackup(false)" type="button">â¬† ç«‹å³å¤‡ä»½</button>
</div>
</div>
</div>
<div class="container" id="view"></div>
<button class="fab" id="fab" onclick="onFabBtn()">ï¼‹</button>
<!-- æ–°å»º / ç¼–è¾‘ä¸“è¾‘å¼¹çª— -->
<div id="dlgNewAlbum" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.28);z-index:99;align-items:center;justify-content:center;">
<div style="width:min(92vw,420px);background:#fff;border-radius:16px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.15)">
<h3 id="dlgAlbTitle" style="margin:0 0 12px">æ–°å»ºä¸“è¾‘</h3>
<label>åç§°ï¼š</label>
<input id="dlgAlbName" placeholder="ç»™ä¸“è¾‘èµ·ä¸ªåå­—" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin:6px 0 12px"/>
<!-- ç±»å‹æ”¹æˆå¯è‡ªå®šä¹‰è¾“å…¥ -->
<div style="margin-bottom:14px">
<div style="font-size:14px;margin-bottom:4px;">ç±»å‹æ ‡ç­¾ï¼š</div>
<input id="dlgAlbType" placeholder="ä¾‹å¦‚ï¼šæ–‡ç« æœ¬ / å­—ä½“ä¸“è¾‘ / é“¾æ¥æœ¬â€¦" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;box-sizing:border-box;"/>
<!-- å¿«é€Ÿå¡«å…¥çš„å°æŒ‰é’®ï¼Œä¸æƒ³ç”¨å°±æ— è§† -->
<div style="margin-top:6px;font-size:12px;color:#999;display:flex;gap:6px;flex-wrap:wrap;">
<span>å¿«é€Ÿå¡«å…¥ï¼š</span>
<button onclick="quickAlbType('å­—ä½“ä¸“è¾‘')" style="padding:2px 8px;border:1px solid #eee;border-radius:999px;background:#f9f9f9;font-size:12px;" type="button">å­—ä½“ä¸“è¾‘</button>
<button onclick="quickAlbType('æ–‡ç« æœ¬')" style="padding:2px 8px;border:1px solid #eee;border-radius:999px;background:#f9f9f9;font-size:12px;" type="button">æ–‡ç« æœ¬</button>
<button onclick="quickAlbType('ç½‘å€æœ¬')" style="padding:2px 8px;border:1px solid #eee;border-radius:999px;background:#f9f9f9;font-size:12px;" type="button">ç½‘å€æœ¬</button>
</div>
</div>
<div style="font-size:12px;color:#777;margin-bottom:14px">
      å°æç¤ºï¼šå¦‚æœè¿™æ˜¯ç”¨æ¥å­˜é“¾æ¥çš„ä¸“è¾‘ï¼Œå¯ä»¥åœ¨æ¯ä¸€é¡µçš„ã€ŒURLã€è¾“å…¥æ¡†é‡Œï¼Œä¸€è¡Œä¸€æ¡è®°å½•é“¾æ¥ï½
    </div>
<div style="display:flex;gap:10px;justify-content:flex-end;align-items:center">
<!-- ç¼–è¾‘æ¨¡å¼ä¸‹æ‰ä¼šæ˜¾ç¤º -->
<button id="dlgDelete" onclick="onDeleteAlbum()" style="margin-right:auto;display:none;padding:6px 10px;border:1px solid #f5b5b5;border-radius:10px;background:#fff5f5;color:#c00;font-size:13px">
        åˆ é™¤ä¸“è¾‘
      </button>
<button id="dlgCancel" onclick="onNewAlbumCancel()" style="padding:8px 12px;border:1px solid #ddd;border-radius:10px;background:#fff">
        å–æ¶ˆ
      </button>
<button id="dlgOk" onclick="onNewAlbumOk()" style="padding:8px 14px;border:none;border-radius:10px;background:#6b8cff;color:#fff">
        ç¡®è®¤
      </button>
</div>

<style>
.reading .detail-toolbar,
.reading .detail-header{display:none!important;}
.reading .detail-view{padding-top:12px;}
</style>

<script>
// === é€šç”¨ä¿å­˜ä¿®å¤ï¼šä¸€/äºŒç‰ˆæœ¬æ–‡å­—è¾“å…¥å³æ—¶ä¿å­˜ ===
document.addEventListener('input', (e)=>{
  const el = e.target;
  if (!el) return;
  if (el.matches('textarea, .note-editor')){
    try{
      const alb = db.albums.find(a=>a.id===current.albumId);
      const page = alb?.pages.find(p=>p.id===current.pageId);
      if (!page) return;
      page.note = el.value ?? el.innerText ?? '';
      page.updated = Date.now();
      autosave();
    }catch(err){}
  }
});
</script>
<style>
:root{
  --bg:#fff;
  --fg:#222;
  --muted:#666;
  --primary:#ff7aa8; /* ç²‰ */
  --card:#ffffff;
  --card-border:#eee;
  --chip-bg:#ffe5ef;
  --chip-fg:#b03b66;
  --shadow:0 6px 20px rgba(0,0,0,.06);
  --radius:14px;
}
html,body{height:100%;}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,BlinkMacSystemFont,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;}
/* é¡¶æ  */
.header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:5}
.header .row{display:flex;align-items:center;gap:10px;padding:10px 12px;max-width:980px;margin:0 auto;}
.header .title{font-weight:700;font-size:18px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.btn{appearance:none;border:1px solid var(--card-border);background:#fff;padding:8px 12px;border-radius:999px;box-shadow:var(--shadow);cursor:pointer;}
.iconbtn{border:none;background:transparent;padding:8px;border-radius:10px;}
.badge{font-size:12px;color:#fff;background:var(--primary);padding:2px 8px;border-radius:999px;margin-left:6px}
/* ä¹¦æ¶ç½‘æ ¼ */
.container{max-width:980px;margin:0 auto;padding:12px;display:block}
.grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px}
@media(min-width:700px){.grid{grid-template-columns:repeat(3, minmax(0,1fr));}}
/* æ­£æ–‡å­—å—èƒŒæ™¯ */
.rich-editor {
  background: rgba(255,255,255,0.6);
  border-radius: 12px;
  padding: 10px;
}
/* â­ è¢«ç½®é¡¶çš„æ ‡ç­¾æ ·å¼ï¼ˆå»æ‰æ˜Ÿå·ï¼‰ */
.tag-pinned {
  position: relative;
  background: #ffeef5 !important;
  border-color: #ff84b3 !important;
  color: #ff5c9a !important;
}
.tag-pinned::after {
  content: none !important;
}
/* åªéšè—æ ‡ç­¾æ¡ä¸Šçš„é‚£é¢—â­ï¼Œç¼©ç•¥å›¾ä¸Šçš„æ˜Ÿæ˜Ÿä¸åŠ¨ */
#tagBar .star {
  display: none !important;
}

/* â­ æ–°å¢ï¼šä¸“é—¨ç»™â€œé¡µç¼©ç•¥å›¾â€ç”¨çš„ç¼©æ”¾ç½‘æ ¼ï¼Œæ”¯æŒ æ›´å°/ è¶…å° /å° / ä¸­ / å¤§ */
.grid.thumb-grid{grid-template-columns:repeat(2, minmax(0,1fr));}

/* å°ï¼šä¸€æ¬¡å¤šæ”¾å‡ å¼ ï¼ˆ3åˆ—ï¼‰ */
.grid.thumb-grid.thumb-s{
  grid-template-columns:repeat(3, minmax(0,1fr)) !important;
}

/* ä¸­ï¼šé»˜è®¤ï¼ˆ2åˆ—ï¼‰ */
.grid.thumb-grid.thumb-m{
  grid-template-columns:repeat(2, minmax(0,1fr)) !important;
}

/* å¤§ï¼šä¸€åˆ—å¤§å¡ç‰‡ */
.grid.thumb-grid.thumb-l{
  grid-template-columns:repeat(1, minmax(0,1fr)) !important;
}
/* 4 åˆ—ï¼šè¶…å°å¡ç‰‡ */
.grid.thumb-grid.thumb-4c{
  grid-template-columns:repeat(4, minmax(0,1fr)) !important;
}

/* 5 åˆ—ï¼šæ›´å°ï¼Œä¸€å±å¡æ›´å¤š */
.grid.thumb-grid.thumb-5c{
  grid-template-columns:repeat(5, minmax(0,1fr)) !important;
}

.card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;min-height:160px;}
.card .cover{aspect-ratio:16/10;background:#f6f6f6 center/cover no-repeat;position:relative}
.card .cover .label{position:absolute;left:8px;bottom:8px;background:rgba(0,0,0,.55);color:#fff;font-size:12px;padding:2px 6px;border-radius:999px}
.card .cover .card-menu-btn{
  position:absolute;
  top:8px;
  right:8px;
  background:rgba(0,0,0,.55);
  color:#fff;
  border:none;
  border-radius:999px;
  padding:2px 8px;
  font-size:14px;
  cursor:pointer;
}
.card .body{padding:10px 12px}
.card .name{font-weight:700}
.card .sub{color:var(--muted);font-size:12px;margin-top:4px}
.row{display:flex;gap:8px;align-items:center}
.spacer{flex:1}
/* é¡µç¼©ç•¥å›¾ç½‘æ ¼ */
.thumb{border-radius:10px;border:1px solid var(--card-border);overflow:hidden;background:#fafafa;position:relative}
.thumb .img{aspect-ratio:1/1;background:#eee center/cover no-repeat}
.thumb .meta{padding:8px 10px}
.star{position:absolute;right:8px;top:8px;background:rgba(255,255,255,.8);border:1px solid var(--card-border);border-radius:999px;padding:6px;box-shadow:var(--shadow)}
.star.on{background:gold;border-color:#e0c000}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.chip{background:var(--chip-bg);color:var(--chip-fg);border-radius:999px;padding:2px 8px;font-size:12px}
/* æ ‡ç­¾ç­›é€‰æ¡ï¼šé¡¶éƒ¨é‚£ä¸€æ’å¯å·¦å³æ»‘åŠ¨çš„å°æŒ‰é’® */
.tag-row{
  margin-bottom:8px;
  overflow-x:auto;
  flex-wrap:nowrap;
}
.tag-row::-webkit-scrollbar{display:none;}

.tag-btn{
  white-space:nowrap;
  font-size:12px;
  padding:4px 10px;
}

/* è¢«é€‰ä¸­çš„æ ‡ç­¾æŒ‰é’®ç¨å¾®äº®ä¸€ç‚¹ */
.tag-btn.tag-on{
  filter:brightness(1.08);
  box-shadow:0 0 0 1px rgba(0,0,0,.06);
}
/* è¯¦æƒ…é¡µ */
.detail{display:flex;flex-direction:column;gap:10px}
.detail .imgbox{
    background:#000;
    display:flex;
    justify-content:center;
    align-items:center;
    border-radius:12px;
    overflow:hidden;
    position:relative;   /* æ–°å¢è¿™ä¸€è¡Œï¼Œè®©é‡Œé¢çš„ç®­å¤´å¯ä»¥ç»å¯¹å®šä½ */
}
/* æ–‡å­—é¡µ / å›¾æ–‡æ··æ’é¡µï¼šæŠŠä¸Šé¢çš„å¤§å›¾åŒºåŸŸè—æ‰ï¼Œåªç”¨ä¸‹é¢çš„æ­£æ–‡ */
.detail[data-layout="note"] .imgbox,
.detail[data-layout="rich"] .imgbox{
  display:none;
}
/* å›¾æ–‡æ··æ’ä¸“ç”¨æŒ‰é’®ï¼šåªæœ‰ rich å¸ƒå±€æ˜¾ç¤º */
.detail[data-layout="image"] #btnInsertImg,
.detail[data-layout="note"]  #btnInsertImg,
.detail[data-layout="image"] #btnToggleImgEdit,
.detail[data-layout="note"]  #btnToggleImgEdit,
.detail[data-layout="image"] #btnResizeMode,
.detail[data-layout="note"]  #btnResizeMode,
.detail[data-layout="image"] #btnMoveMode,
.detail[data-layout="note"]  #btnMoveMode{
  display:none !important;
}
.detail img{max-width:100%;height:auto;display:block}
.field{display:flex;flex-direction:column;gap:6px}
.input, textarea{width:100%;padding:10px 12px;border:1px solid var(--card-border);border-radius:10px;background:#fff;box-sizing:border-box}
small.muted{color:var(--muted)}
.toolbar{position:sticky;bottom:10px;display:flex;gap:10px;justify-content:center;margin:10px 0}
/* é»˜è®¤æ˜¾ç¤ºï¼ˆä¸»é¡µç”¨ï¼‰ */
.fab{
  position:fixed;
  right:18px;
  bottom:18px;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:999px;
  width:56px;
  height:56px;
  display:flex;              /* æ”¹å›æ˜¾ç¤º */
  align-items:center;
  justify-content:center;
  font-size:28px;
  box-shadow:var(--shadow);
  cursor:pointer;
  z-index:999;
}

/* è¯¦æƒ…é¡µéšè— */
body.detail .fab{
  display:none !important;
}
.page-nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  width:36px;
  height:36px;
  border-radius:50%;
  border:1px solid var(--card-border);
  background:rgba(255,255,255,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  cursor:pointer;
  box-shadow:var(--shadow);
}
.page-nav.left{ left:8px; }
.page-nav.right{ right:8px; }
.page-nav:disabled{
  opacity:.4;
  cursor:default;
}
/* æœç´¢ç»“æœåˆ—è¡¨ */
.list .item{display:flex;gap:10px;padding:10px;border-bottom:1px solid var(--card-border)}
.item .mini{width:64px;height:64px;background:#eee center/cover no-repeat;border-radius:8px;border:1px solid var(--card-border)}
.item .txt{flex:1}
.item .t{font-weight:700}
.hl{background:linear-gradient(transparent 20%, #fff0a8 20%, #fff0a8 80%, transparent 80%);}
/* ä¸»é¢˜ï¼šç²‰ / è“ / ç™½/ é»‘ */
/* ç²‰Â·æ¢¦ç³– */
.theme-pink {
  --primary:#ff7aa8;
  --bg:#fff;
  --card:#fff;
  --fg:#333;
  --chip-bg:#ffe5ef;
  --chip-fg:#b03b66;
}

/* è“Â·æ¸…é£ */
.theme-blue {
  --primary:#a9d8ff;
  --bg:#fafdff;
  --card:#ffffff;
  --fg:#2b3e57;
  --chip-bg:#e8f4ff;
  --chip-fg:#3a6be0;
}

/* ç™½Â·æç®€ */
.theme-white {
  --primary:#bbb;
  --bg:#ffffff;          /* çœŸÂ·çº¯ç™½åº• */
  --card:#ffffff;
  --fg:#444;
  --chip-bg:#f9f9f9;
  --chip-fg:#666;
}

/* é»‘Â·å¤œå¹• */
.theme-dark {
  --primary:#444;        /* æŒ‰é’®æ·±ç°ï¼Œä¸ç²‰ */
  --bg:transparent;      /* ä¿ç•™åº•å›¾ï¼ä¸è¦é»‘åº• */
  --card:#ffffff;   /* å¡ç‰‡ä¿æŒç™½åº• */
  --fg:#444;
  --chip-bg:#333;
  --chip-fg:#ddd;
}
/* é»‘è‰²ä¸»é¢˜ä¸‹åŠ å·æŒ‰é’®æ”¹ä¸ºçº¯é»‘åº•ç™½å­— */
body.theme-dark .fab {
  background: #000 !important;
  color: #fff !important;
}
/* ç™½è‰²ä¸»é¢˜ä¸‹ï¼šé¡¶æ æŒ‰é’®ä¿æŒç™½è‰²ï¼Œä¸è¦å˜æˆç°å— */
body.theme-white .header .btn {
  background:#fff;
  color:#444;
  border:1px solid var(--card-border);
}

/* è®©ç™½è‰²ä¸»é¢˜çœŸæ­£çº¯ç™½ï¼ŒæŒ‰é’®ä¸ç° */
body.theme-white .header .btn {
  background: #fff !important;
  color: #444 !important;
  border: 1px solid #ddd !important;
}


/* === ç™½è‰²ä¸»é¢˜ä¸‹ï¼ŒåŠ å·æŒ‰é’®æ”¹ä¸ºçº¯ç™½ === */
body.theme-white .fab {
  background: #fff !important;
  color: #222 !important;
  border: 1px solid #ddd !important;
}
body.theme-dark .header .title {
  color: #222 !important;           /* é¡¶éƒ¨æ ‡é¢˜ä¿æŒæ·±è‰² */
}

/* === æœç´¢ç»“æœæ‰€æœ‰æ–‡å­—å¼ºåˆ¶é»‘è‰² === */
#searchResultInline,
#searchResultInline *,
.list .item *,
.list .item .txt,
.list .item .sub {
  color: #000 !important;
}
/* é¡¶æ æŒ‰é’®è‡ªåŠ¨è·Ÿéšä¸»é¢˜è‰² */
.header .btn {
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 6px 12px;
    margin-left: 6px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.header .btn:hover {
    filter: brightness(1.1);
    transform: translateY(-1px);
}


/* å»æ‰ä¸‘çš„â€œè®¾é¦–é¡µèƒŒæ™¯â€ç°æ¡† */
#btnTheme, #btnFav, #btnSearch {
    box-shadow: 0 0 5px rgba(255,255,255,0.3);
}
/* çŠ¶æ€ç‚¹ */
.statusdot{width:10px;height:10px;border-radius:50%;background:#bbb;display:inline-block;margin-left:6px}
.statusdot.ok{background:#16c60c}
/* ç¬”è®°é‡Œçš„å°ç¼©ç•¥å›¾æ ·å¼ */
.thumbnail{
  max-width: 100%;
  height: auto;
  border-radius: 6px;
  cursor: pointer;
}
/* å…¨å±å›¾ç‰‡é¢„è§ˆè’™ç‰ˆ */
.img-preview-mask{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.img-preview-mask img{
  max-width: 96vw;
  max-height: 96vh;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
}

/* é¼ æ ‡/æ‰‹æŒ‡æŒ‰ä½æ—¶å¾®å¾®æ”¾å¤§ä¸€ç‚¹ */
.thumbnail:hover{
  transform: scale(1.05);
  transition: 0.2s;
}
/* å¯Œæ–‡æœ¬å›¾æ–‡æ··æ’ç¼–è¾‘å™¨ */
.rich-editor{
  min-height:60vh;       /* åŸæ¥æ˜¯ 260pxï¼Œæ”¹æˆå å±å¹• 60% é«˜ */
  max-height:none;
  overflow-y:auto;
  word-break:break-word;
  position:relative;
}

/* æ­£æ–‡é‡Œçš„å°å›¾æ ·å¼ï¼ˆé»˜è®¤å½“è´´çº¸ç”¨ï¼‰ */
.inline-img{
  position:relative;   /* â­ è®°å¾—åŠ è¿™ä¸€è¡Œï¼Œè®© left/top ç”Ÿæ•ˆ */
  max-width:100%;
  width:60%;
  height:auto;
  display:block;
  margin:10px auto;
  border-radius:12px;
  cursor:pointer;
}
/* â€”â€” v1.3 é¢å¤–ï¼šé¡¶æ å†…è”é¢æ¿ â€”â€” */
#inlineBars{padding-top:0}
#searchBar,#themeBar{display:none;padding:8px 0}
</style>
<script>
// â€”â€” å›¾ç‰‡å·¥å…·ï¼šé¢„è§ˆ + ç¼–è¾‘æ¨¡å¼ï¼ˆæ‹–åŠ¨ / ç¼©æ”¾ï¼‰ â€”â€”

// ç‚¹å‡»å°å›¾æ”¾å¤§çœ‹çœ‹åŸå›¾ï¼ˆç¼–è¾‘æ¨¡å¼å…³çš„æ—¶å€™æ‰ç”Ÿæ•ˆï¼‰
function openImagePreview(src){
  if (!src) return;
  const mask = document.createElement('div');
  mask.className = 'img-preview-mask';
  mask.innerHTML = `<img src="${src}" alt="preview">`;
  mask.onclick = () => mask.remove();   // ç‚¹ä»»æ„åœ°æ–¹å…³é—­
  document.body.appendChild(mask);
}
// â€”â€” å›¾ç‰‡ç‚¹å‡»ï¼šé¢„è§ˆ + ç¼©æ”¾ + æ‹–åŠ¨ï¼ˆæ”¹è¿›ç‰ˆ + æ”¯æŒåˆ å¤§å›¾ï¼‰ â€”â€”
document.addEventListener('click', function (e) {
  const el = e.target;
  if (!el || el.tagName !== 'IMG') return;

  const isInline = el.classList.contains('inline-img'); // å›¾æ–‡æ··æ’å°å›¾
  const isThumb  = el.classList.contains('thumbnail');  // note é¡µç¼©ç•¥å›¾
  const isMain   = !!el.closest('.imgbox');             // è¯¦æƒ…é¡µå¤§å›¾

  // ğŸ—‘ åˆ é™¤å›¾ç‰‡æ¨¡å¼ï¼šæ­£æ–‡é‡Œçš„å°å›¾ï¼ˆinline-imgï¼‰
  if (isInline && window.__imgEditMode && window.__imgDeleteMode) {
    const editor = el.closest('.rich-editor');
    if (editor) {
      if (confirm('è¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
        const p = el.parentElement;

        el.remove();

        if (
          p &&
          p.tagName === 'P' &&
          !p.textContent.trim() &&
          !p.querySelector('img')
        ) {
          p.remove();
        }

        editor.dispatchEvent(new Event('input', { bubbles: true }));
      }
    }
    return;
  }

  // ğŸ—‘ åˆ é™¤å›¾ç‰‡æ¨¡å¼ï¼šè¯¦æƒ…é¡µå¤§å›¾
  if (isMain && window.__imgEditMode && window.__imgDeleteMode) {
    // æ‰¾åˆ°å½“å‰ä¸“è¾‘å’Œå½“å‰é¡µ
    const alb = db.albums.find(a => a.id === current.albumId);
    if (!alb) return;
    const page = alb.pages.find(p => p.id === current.pageId);
    if (!page || !page.img) return;

    if (!confirm('è¦åˆ é™¤è¿™å¼ ä¸»å›¾å—ï¼Ÿ')) return;

    page.img = '';
    page.updated = Date.now();
    autosave();
    render();
    return;
  }

  // â‘  ç¼–è¾‘ + æ”¾å¤§ç¼©å°æ¨¡å¼ï¼šåªå¯¹ inline-img ç”Ÿæ•ˆ
  if (isInline && window.__imgEditMode && window.__imgResizeMode) {
    const sizes = [20, 40, 60, 80, 100];
    let idx = Number(el.dataset.szIndex || '-1');
    idx = (idx + 1) % sizes.length;
    el.style.width = sizes[idx] + '%';
    el.style.height = 'auto';
    el.dataset.szIndex = String(idx);

    const editor = el.closest('.rich-editor');
    if (editor) editor.dispatchEvent(new Event('input', { bubbles: true }));
    return;
  }

  // â‘¡ æ™®é€šç‚¹å‡» â†’ æ‰“å¼€é¢„è§ˆï¼ˆåˆ é™¤æ¨¡å¼å…³çš„æ—¶å€™ï¼‰
  if (isInline || isThumb || isMain) {
    openImagePreview(el.src);
  }
});
// ğŸ†• æ‹–åŠ¨æ¨¡å¼é€»è¾‘ï¼ˆä¼šè®°ä½ä½ç½®ç‰ˆï¼‰
let dragImg = null, startX = 0, startY = 0, baseX = 0, baseY = 0;

document.addEventListener('pointerdown', (e)=>{
  if (!window.__imgEditMode || !window.__imgMoveMode) return;
  const el = e.target;
  if (el.tagName === 'IMG' && el.classList.contains('inline-img')) {

    dragImg = el;
    dragImg.style.position   = 'relative';
    dragImg.style.touchAction = 'none';

    startX = e.clientX;
    startY = e.clientY;

    // å·²æœ‰åç§»é‡ï¼ˆä¸Šä¸€æ¬¡æ‹–åŠ¨ç»“æœï¼‰
    baseX = Number(dragImg.dataset.offX || '0');
    baseY = Number(dragImg.dataset.offY || '0');

    e.preventDefault();
  }
});

document.addEventListener('pointermove', (e)=>{
  if (!dragImg) return;
  const dx = e.clientX - startX;
  const dy = e.clientY - startY;

  const curX = baseX + dx;
  const curY = baseY + dy;

  dragImg.style.left = curX + 'px';
  dragImg.style.top  = curY + 'px';

  // å†™å…¥ data-*ï¼Œä¸‹æ¬¡è¿˜èƒ½æ¥ç€æ‹–
  dragImg.dataset.offX = String(curX);
  dragImg.dataset.offY = String(curY);
});

document.addEventListener('pointerup', ()=>{
  if (dragImg) {
    // é€šçŸ¥ç¼–è¾‘å™¨â€œå†…å®¹å˜äº†â€ï¼Œè§¦å‘ä¿å­˜
    const editor = dragImg.closest('.rich-editor');
    if (editor) {
      editor.dispatchEvent(new Event('input', { bubbles: true }));
    }
    dragImg = null;
  }
});
// â­ æ ‡é¢˜ / æ ‡ç­¾ / æ­£æ–‡ / URLï¼ˆnote + rich + fontï¼‰ç»Ÿä¸€è‡ªåŠ¨ä¿å­˜
document.addEventListener('input', (e) => {
  const alb = db.albums.find(a => a.id === current.albumId);
  if (!alb) return;
  const p = alb.pages.find(p => p.id === current.pageId);
  if (!p) return;

  const el = e.target;

  // æ ‡é¢˜
  if (el.id === 'inpTitle') {
    p.title = el.value.trim();
    p.updated = Date.now();
    autosave();
    return;
  }

  // æ ‡ç­¾
  if (el.id === 'inpTags') {
    const tags = el.value
      .split(/\s+/)
      .filter(Boolean);
    p.tags = tags;
    p.updated = Date.now();
    autosave();
    return;
  }

  // æ™®é€šæ­£æ–‡ï¼štextareaï¼ˆæ¨¡å¼ 1 + 2 çš„â€œæ­£æ–‡â€ï¼‰+ å­—ä½“é¢„è§ˆæ–‡æ¡ˆ
  if (el.id === 'inpNote') {
    p.note = el.value;
    p.updated = Date.now();
    autosave();

    if (p.layout === 'font') {
      const preview = document.getElementById('fontPreview');
      if (preview) {
        preview.textContent = p.note || 'åœ¨ä¸‹é¢è¾“å…¥æ–‡å­—ï¼Œè¿™é‡Œé¢„è§ˆæ•ˆæœ';
      }
    }
    return;
  }

  // URL åˆ—è¡¨ï¼ˆå­—ä½“ / å›¾ç‰‡é“¾æ¥ï¼Œæ¯è¡Œä¸€æ¡ï¼‰
  if (el.id === 'inpUrls') {
    const lines = (el.value || '')
      .split(/\n+/)
      .map(s => s.trim())
      .filter(Boolean);
    p.urls = lines;
    p.updated = Date.now();
    autosave();

    if (p.layout === 'font') {
      const first = lines[0] || '';
      applyUrlPreview(first);
    }
    return;
  }

  // å›¾æ–‡æ··æ’æ­£æ–‡ï¼šcontenteditable divï¼ˆæ¨¡å¼ 3ï¼‰
  if (el.id === 'richEditor') {
    p.rich = el.innerHTML;
    p.updated = Date.now();
    autosave();
    return;
  }
});

// æ ¹æ® URL / TTF é“¾æ¥åº”ç”¨å­—ä½“é¢„è§ˆï¼ˆä»…å½“å‰è¯¦æƒ…é¡µç”Ÿæ•ˆï¼‰
function applyUrlPreview(url){
  try{
    if(!url) return;
    if(!/^https?:\/\//.test(url)) return;

    var box = document.getElementById('fontPreview');
    if(!box) return;

    // å…ˆæ¸…ç†å¯èƒ½å­˜åœ¨çš„åŠ¨æ€å­—ä½“æ ·å¼
    var styleId = 'dynamicFontPreview';
    var old = document.getElementById(styleId);
    if(old && old.parentNode) old.parentNode.removeChild(old);

    // åˆ¤æ–­æ˜¯ä¸æ˜¯å­—ä½“æ–‡ä»¶ï¼ˆç®€å•æŒ‰åç¼€åï¼‰
    var clean = url.split('?')[0] || '';
    if(/\.(ttf|otf|woff2?|TTF|OTF|WOFF2?)$/.test(clean)){
      // å­—ä½“é¢„è§ˆï¼šå†™å…¥ @font-face
      var style = document.createElement('style');
      style.id = styleId;
      style.textContent = `
        @font-face {
          font-family: 'MoxiePreviewFont';
          src: url('` + url.replace(/'/g, "\'") + `');
          font-weight: normal;
          font-style: normal;
        }
        #fontPreview{
          font-family: 'MoxiePreviewFont', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
          background-image: none !important;
        }
      `;
      document.head.appendChild(style);

      box.textContent = 'Abc ä½ å¥½';
      box.style.display = 'flex';
      box.style.alignItems = 'center';
      box.style.justifyContent = 'center';

    }else{
      // å›¾ç‰‡ / å…¶ä»–èµ„æºï¼šå½“æˆå›¾ç‰‡é¢„è§ˆ
      box.style.fontFamily = '';
      box.style.backgroundImage = 'none';

      while(box.firstChild) box.removeChild(box.firstChild);
      var img = new Image();
      img.src = url;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      img.style.objectFit = 'contain';
      box.appendChild(img);
    }

  }catch(e){
    console.error('applyUrlPreview error', e);
  }
}


function initFontThumbs(){
  try{
    var boxes = document.querySelectorAll('.thumb .img.font-thumb');
    if(!boxes.length) return;

    // æ¸…ç†æ—§çš„ç¼©ç•¥å­—ä½“æ ·å¼ï¼Œé¿å…è¶Šæ¸²æŸ“è¶Šå¤š
    var oldStyles = document.querySelectorAll('style[data-font-thumb="1"]');
    oldStyles.forEach(function(s){
      if(s && s.parentNode) s.parentNode.removeChild(s);
    });

    boxes.forEach(function(box, idx){
      var url = box.getAttribute('data-url') || '';
      if(!url) return;
      var clean = (url.split('?')[0] || '').toLowerCase();
      var isFont = /\.(ttf|otf|woff2?)$/.test(clean);
      if(!isFont) return;

      var fam = 'MoxieFontThumb_' + idx;
      var st = document.createElement('style');
      st.setAttribute('data-font-thumb','1');
      st.textContent = "@font-face{font-family:'"+fam+"';src:url('"+url.replace(/'/g, "\'")+"');font-weight:normal;font-style:normal;}";
      document.head.appendChild(st);

      var span = box.querySelector('.font-sample');
      if(!span){
        span = document.createElement('span');
        span.className = 'font-sample';
        span.textContent = 'Abc ä½ å¥½';
        box.appendChild(span);
      }
      span.style.fontFamily = fam + ", system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
      span.style.display = 'flex';
      span.style.alignItems = 'center';
      span.style.justifyContent = 'center';
      span.style.width = '100%';
      span.style.height = '100%';
    });
  }catch(e){
    console.error('initFontThumbs error', e);
  }
}

// v1.3 SafeButtonsï¼šæ‰€æœ‰å…³é”®æŒ‰é’®ç”¨å†…è” onclickï¼Œé¿å…äº‹ä»¶è¢«å
function onSearchBtn(){ var b=document.getElementById('searchBar'); if(!b) return; b.style.display=(b.style.display==='none'||b.style.display==='')?'block':'none'; }
function onThemeBtn(){ var b=document.getElementById('themeBar'); if(!b) return; b.style.display=(b.style.display==='none'||b.style.display==='')?'block':'none'; }
function onFavBtn(){ current.view='favs'; current.results=null; render(); }

function onFabBtn(){
  // é¦–é¡µï¼šç‚¹ + = æ–°å»ºä¸“è¾‘
  if (current.view === 'home') {
    openNewAlbumDialog();
    return;
  }

  // åªæœ‰åœ¨ã€Œä¸“è¾‘å†…éƒ¨ã€æ‰å¼¹å‡º 1/2/3/4 é€‰æ‹©
  if (current.view !== 'album') return;

  var choice = prompt(
    'è¾“å…¥æ•°å­—é€‰æ‹©æ“ä½œ:\n' +
    '1 å¯¼å…¥å›¾ç‰‡ï¼ˆæ¯å¼ è‡ªåŠ¨å˜æˆä¸€é¡µï¼‰\n' +
    '2 æ–°å»ºæ–‡å­—+å¤šå›¾é¡µï¼ˆæ­£æ–‡åœ¨ä¸Šé¢ï¼Œä¸‹é¢æœ‰å°ç¼©ç•¥å›¾ï¼‰\n' +
    '3 æ–°å»ºå›¾æ–‡æ··æ’é¡µï¼ˆå¯ä»¥åœ¨æ­£æ–‡é‡Œæ’å…¥å°å›¾ï¼‰\n' +
    '4 æ–°å»ºå­—ä½“é¢„è§ˆé¡µï¼ˆä¸ŠåŠé¢„è§ˆï¼Œä¸‹åŠè¾“å…¥ URL/ttfï¼‰',
    '1'
  );

  var alb = db.albums.find(a => a.id === current.albumId);
  if (!choice || !alb) return;

  if (choice === '1') {
    // â‘  ä¸€æ¬¡å¯¼å…¥å¾ˆå¤šå›¾ç‰‡ï¼šæ¯å¼ å˜æˆå•ç‹¬ä¸€é¡µ
    pickImages((arr) => {
      arr.forEach(data => {
        alb.pages.push({
          id: id(),
          title: '',
          note: '',
          tags: [],
          urls: [],
          img: data,
          star: false,
          created: Date.now(),
          updated: Date.now()
        });
      });
      autosave();
      render();
    });

  } else if (choice === '2') {
    // â‘¡ æ–‡å­— + å¤šå›¾æ¨¡å¼ï¼ˆä¸Šé¢æ­£æ–‡ï¼Œä¸‹é¢ä¸€æ’ç¼©ç•¥å›¾ï¼‰
    var p2 = {
      id: id(),
      title: '',
      note: '',
      tags: [],
      urls: [],
      layout: 'note',
      imgList: [],
      img: null,
      star: false,
      created: Date.now(),
      updated: Date.now()
    };
    alb.pages.push(p2);
    autosave();
    openPage(alb.id, p2.id);

  } else if (choice === '3') {
    // â‘¢ å›¾æ–‡æ··æ’æ¨¡å¼ï¼ˆå¯ä»¥åœ¨æ­£æ–‡é‡Œæ’å…¥å°å›¾ï¼Œæ”¯æŒç¼©æ”¾ / æ‹–åŠ¨ï¼‰
    var p3 = {
      id: id(),
      title: '',
      note: '',
      rich: '',
      tags: [],
      urls: [],
      layout: 'rich',
      imgList: [],
      img: null,
      star: false,
      created: Date.now(),
      updated: Date.now()
    };
    alb.pages.push(p3);
    autosave();
    openPage(alb.id, p3.id);

  } else if (choice === '4') {
    // â‘£ å­—ä½“é¢„è§ˆé¡µï¼šä¸ŠåŠé¢„è§ˆï¼Œä¸‹åŠè¾“å…¥
    var p4 = {
      id: id(),
      title: '',
      note: '',
      rich: '',
      tags: [],
      urls: [],
      layout: 'font',
      imgList: [],
      img: null,
      star: false,
      created: Date.now(),
      updated: Date.now()
    };
    alb.pages.push(p4);
    autosave();
    openPage(alb.id, p4.id);
  }
}
/* ===== æ•°æ®å±‚ ===== */
window.__imgEditMode = false;   // å›¾ç‰‡ç¼–è¾‘æ¨¡å¼ï¼šé»˜è®¤å…³
window.__imgResizeMode = false;
window.__imgMoveMode = false;
const LS_KEY='moxie_books_v1';
let db = load() || {
  meta:{theme:'pink', bgs:{home:null,grid:null,detail:null}},
  albums:[
    {id:id(), name:'æ–‡ç« æœ¬',   type:'article', cover:null, bgGrid:null, bgDetail:null, pages:[]},
    {id:id(), name:'å­—ä½“',     type:'fonts',   cover:null, bgGrid:null, bgDetail:null, pages:[]},
    {id:id(), name:'ç½‘å€æ”¶è—', type:'url',     cover:null, bgGrid:null, bgDetail:null, pages:[]},
  ]
};
let current = {
  view: 'home',
  albumId: null,
  pageId: null,
  onlyStar: false,
  tagFilter: null,    // â­ å½“å‰é€‰ä¸­çš„æ ‡ç­¾ï¼ˆnull = ä¸ç­›é€‰ï¼‰
  results: null,
  readingMode: false  // ğŸ“– é˜…è¯»æ¨¡å¼å¼€å…³
};
let currentAlbumEditId = null;  // æ­£åœ¨ç¼–è¾‘å“ªæœ¬ä¸“è¾‘ï¼ˆnull = æ–°å»ºï¼‰
function id(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function save(){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(db));
    markSaved();                 // å°ç»¿ç‚¹äº®èµ·ï¼šè¯´æ˜å­˜ä½äº†
  }catch(e){
    console.error(e);
    alert('å­˜å‚¨å¤±è´¥äº†ï¼šå›¾ç‰‡å¤ªå¤šæˆ–å¤ªå¤§ï¼Œæµè§ˆå™¨çš„æœ¬åœ°ç©ºé—´å·²ç»å¿«æ»¡äº†(>_<)\n' +
          'å¯ä»¥å…ˆåˆ æ‰ä¸€äº›ä¸å¤ªé‡è¦çš„é¡µï¼Œæˆ–è€…æ¢å°ä¸€ç‚¹çš„å›¾å†è¯•ä¸€æ¬¡ï½');
  }
}
function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||''); }catch(e){ return null; } }
/*
async // å¯é€‰ï¼šè¯·æ±‚æµè§ˆå™¨â€œå°½é‡åˆ«æŠŠæˆ‘çš„å­˜æ¡£æ¸…æ‰â€
(function(){
  try{
    if (navigator.storage && navigator.storage.persist) {
      navigator.storage.persist();
    }
  }catch(e){}
})();
*/

function markDirty(){
  const d = document.getElementById('statusDot');
  if (d) d.classList.remove('ok');
}
function markSaved(){
  const d = document.getElementById('statusDot');
  if (d) d.classList.add('ok');
}

// auto save
let saveTimer = null;
function autosave(){
  markDirty();
  clearTimeout(saveTimer);
  saveTimer = setTimeout(save, 400);
}
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'hidden') save();
});
window.addEventListener('pagehide', save);
/* ===== ä¸»é¢˜ ===== */
function applyTheme(){
  document.body.classList.remove('theme-pink','theme-blue','theme-white','theme-dark');
  if(db.meta.theme==='pink')  document.body.classList.add('theme-pink');
  if(db.meta.theme==='blue')  document.body.classList.add('theme-blue');
  if(db.meta.theme==='white') document.body.classList.add('theme-white');
  if(db.meta.theme==='dark')  document.body.classList.add('theme-dark');

  // èƒŒæ™¯ï¼šé¦–é¡µ
  document.body.style.backgroundImage = db.meta.bgs.home?`url(${db.meta.bgs.home})`:'';
  document.body.style.backgroundSize='cover';
  document.body.style.backgroundAttachment='fixed';
}
// â­ ç¼©ç•¥å›¾å¤§å°ï¼šs å° / m ä¸­ / l å¤§ / 4c å››åˆ— / 5c äº”åˆ—
function cycleThumbSize(){
  const order = ['s','m','l','4c','5c'];   // ä¾æ¬¡åˆ‡ï¼šå°â†’ä¸­â†’å¤§â†’4åˆ—â†’5åˆ—â†’å†å›å°
  let cur = db.meta.thumbSize || 'm';
  if (!order.includes(cur)) cur = 'm';     // é˜²æ­¢æ—§æ•°æ®é‡Œæ˜¯å¥‡æ€ªå€¼
  const idx = order.indexOf(cur);
  db.meta.thumbSize = order[(idx + 1) % order.length];
  autosave();
  render();
}

/* ===== è§†å›¾æ¸²æŸ“ ===== */
const view=document.getElementById('view');
const titleEl=document.getElementById('title');
const btnBack=document.getElementById('btnBack');

function render(){
  applyTheme();
  const alb = db.albums.find(a=>a.id===current.albumId);
  if(current.view==='home'){
    titleEl.textContent='Moxie Books';
    btnBack.style.display='none';
    view.innerHTML=`<div class="grid">${db.albums.map(a=>albumCard(a)).join('')}</div>`;
    document.body.style.backgroundImage = db.meta.bgs.home?`url(${db.meta.bgs.home})`:'';
} else if (current.view === 'album') {
    // å½“å‰è¿™æœ¬ä¸“è¾‘
    const alb = db.albums.find(a => a.id === current.albumId);

    titleEl.textContent = alb.name + (current.onlyStar ? ' Â· ä»…çœ‹â˜…' : '');
    btnBack.style.display = 'inline-block';

    // å…ˆæŒ‰ã€Œä»…çœ‹â˜…ã€ç­›ä¸€é
    const baseList = alb.pages.filter(p => !current.onlyStar || p.star);

    // æ”¶é›†æ‰€æœ‰å‡ºç°è¿‡çš„æ ‡ç­¾
    const tagSet = new Set();
    alb.pages.forEach(p => (p.tags || []).forEach(t => tagSet.add(t)));
    let tagArr = Array.from(tagSet);

    // è¯»å–æœ¬åœ°ç½®é¡¶æ ‡ç­¾ï¼Œè®©å®ƒä»¬æ’åœ¨æœ€å‰é¢
    const pinnedTags = JSON.parse(localStorage.getItem('pinnedTags') || '[]');
    tagArr.sort((a, b) => pinnedTags.includes(b) - pinnedTags.includes(a));

    // å¦‚æœå½“å‰é€‰ä¸­äº†æŸä¸ªæ ‡ç­¾ï¼Œå†æŒ‰æ ‡ç­¾äºŒæ¬¡ç­›é€‰
    const list = current.tagFilter
      ? baseList.filter(p => (p.tags || []).includes(current.tagFilter))
      : baseList;

    // ç¼©ç•¥å›¾å¤§å°ï¼ˆå° / ä¸­ / å¤§ / 4åˆ— / 5åˆ—ï¼‰
const size = db.meta.thumbSize || 'm';
const labelMap = {
  s:   'å°',
  m:   'ä¸­',
  l:   'å¤§',
  '4c':'è¶…å°',
  '5c':'æ›´å°'
};
const label = labelMap[size] || 'ä¸­';
    // æ ‡ç­¾ç­›é€‰æ¡ HTML
    const tagBarHtml = tagArr.length ? `
      <div class="row tag-row" id="tagBar">
        <button class="btn tag-btn ${current.tagFilter ? '' : 'tag-on'}" data-tag="">
          å…¨éƒ¨
        </button>
        ${tagArr
          .map(
            (t) => `
          <button class="btn tag-btn ${
            current.tagFilter === t ? 'tag-on' : ''
          }" data-tag="${escapeHtml(t)}">
            ${escapeHtml(t)}
          </button>
        `
          )
          .join('')}
      </div>
    ` : '';

    // ç»„è£…æ•´ä¸ªä¸“è¾‘é¡µ
    view.innerHTML = `
      <div class="row" style="margin-bottom:10px">
        <button class="btn" id="btnOnlyStar">
          ${current.onlyStar ? 'ä»…çœ‹â˜…ï¼šå¼€' : 'ä»…çœ‹â˜…ï¼šå…³'}
        </button>
        <button class="btn" id="btnThumbSize">ç¼©ç•¥ï¼š${label}</button>
        <div class="spacer"></div>
        <button class="btn" id="btnSetCover">è®¾å°é¢</button>
        <button class="btn" id="btnSetBg">è®¾èƒŒæ™¯</button>
      </div>

      ${tagBarHtml}

      <div class="grid thumb-grid thumb-${size}">
        ${list.map((p) => thumb(p, alb)).join('')}
      </div>
    `;

    // ã€Œä»…çœ‹â˜…ã€åˆ‡æ¢
    document.getElementById('btnOnlyStar').onclick = () => {
      current.onlyStar = !current.onlyStar;
      render();
    };

    // ç¼©ç•¥å›¾å¤§å°åˆ‡æ¢ï¼ˆå° / ä¸­ / å¤§ï¼‰
    document.getElementById('btnThumbSize').onclick = () => {
      cycleThumbSize();
    };

    // æ ‡ç­¾æ¡ï¼šç‚¹å‡» = ç­›é€‰ï¼›åŒå‡» = ç½®é¡¶/å–æ¶ˆç½®é¡¶
    const tagBar = document.getElementById('tagBar');
    if (tagBar) {
      tagBar.querySelectorAll('button.tag-btn').forEach((btn) => {
        const t = btn.dataset.tag || '';

        // ç‚¹å‡»ï¼šåˆ‡æ¢å½“å‰ç­›é€‰æ ‡ç­¾
        btn.onclick = () => {
          current.tagFilter = t || null; // ç©ºå­—ç¬¦ä¸² = å…¨éƒ¨
          render();
        };

        // æ¸²æŸ“æ—¶ï¼šå¦‚æœæ˜¯ç½®é¡¶æ ‡ç­¾ï¼ŒåŠ ä¸Šç²‰è‰²èƒŒæ™¯
        if (t && pinnedTags.includes(t)) {
          btn.classList.add('tag-pinned');
        }

        // åŒå‡»ï¼šåˆ‡æ¢ç½®é¡¶çŠ¶æ€
        btn.addEventListener('dblclick', (e) => {
          e.preventDefault();
          let stored = JSON.parse(localStorage.getItem('pinnedTags') || '[]');

          if (t && stored.includes(t)) {
            // å·²ç»ç½®é¡¶ -> å–æ¶ˆç½®é¡¶
            stored = stored.filter((x) => x !== t);
          } else if (t) {
            // æ–°ç½®é¡¶ -> æ’åˆ°æœ€å‰é¢
            stored.unshift(t);
          }

          localStorage.setItem('pinnedTags', JSON.stringify(stored));
          render();
        });
      });
    }

    // è®¾å°é¢ï¼šåªæ”¹å°é¢ï¼Œä¸åŠ¨èƒŒæ™¯
    document.getElementById('btnSetCover').onclick = () => {
      const alb = db.albums.find((a) => a.id === current.albumId);
      if (!alb) return;
      pickImage((data) => {
        alb.cover = data;
        save();
        render();
      });
    };

    // è®¾èƒŒæ™¯ï¼šåªæ”¹ä¸“è¾‘ç½‘æ ¼èƒŒæ™¯ï¼Œä¸æ”¹å°é¢
    document.getElementById('btnSetBg').onclick = () => {
      const alb = db.albums.find((a) => a.id === current.albumId);
      if (!alb) return;
      pickImage((data) => {
        alb.bgGrid = data;
        save();
        render();
      });
    };

    // ä¸“è¾‘å†…éƒ¨èƒŒæ™¯
    document.body.style.backgroundImage = alb.bgGrid
      ? `url(${alb.bgGrid})`
      : db.meta.bgs.grid
      ? `url(${db.meta.bgs.grid})`
      : '';
      // å­—ä½“ç¼©ç•¥å›¾é¢„è§ˆï¼ˆç¬¬å››ç§å¸ƒå±€ç”¨ï¼‰
      try{ initFontThumbs(); }catch(e){ console.error(e); }

 }else if(current.view==='detail'){
  const p = alb.pages.find(p=>p.id===current.pageId);
  if (!p) { current.view='album'; render(); return; }

  const isNote  = p.layout === 'note';   // note = æ–‡å­— + å¤šå›¾
  const isRich  = p.layout === 'rich';   // rich = å›¾æ–‡æ··æ’
  const isFont  = p.layout === 'font';   // font = å­—ä½“é¢„è§ˆ
  const detailBg = (p && p.bgDetail) || alb.bgDetail || db.meta.bgs.detail || '';

  // é¡¶éƒ¨æ ‡é¢˜
  titleEl.textContent = alb.name + (p.star ? ' â˜…' : '');
  btnBack.style.display = 'inline-block';

  // åŒä¸“è¾‘å†…çš„ä¸Šä¸€é¡µ / ä¸‹ä¸€é¡µ
  const scope   = listInScope(alb);
  let   idx     = scope.findIndex(x => x.id === p.id);
  if (idx < 0) idx = 0;
  const total   = scope.length || 1;
  const pageIdx = Math.min(idx + 1, total);
  const hasPrev = pageIdx > 1;
  const hasNext = pageIdx < total;
  const progress = Math.round(pageIdx * 100 / total);

  // å°è¿›åº¦æ¡ HTMLï¼ˆåªæœ‰å¤šé¡µæ—¶æ‰æ˜¾ç¤ºï¼‰
  const progressHtml = total > 1 ? `
    <div class="row" id="pageProgressRow"
         style="justify-content:flex-end;align-items:center;
                font-size:12px;color:#666;margin:6px 0 4px;">
      <div style="margin-right:8px;">${pageIdx} / ${total}</div>
      <div style="flex:0 0 60%;max-width:160px;height:6px;
                  border-radius:999px;background:#eee;overflow:hidden;">
        <div style="width:${progress}%;height:100%;
                    background:linear-gradient(90deg,var(--primary),#ffd1e6);"></div>
      </div>
    </div>
  ` : '';

  const showUrlField = isFont;  // å­—ä½“é¢„è§ˆé¡µæ˜¾ç¤º URL è¾“å…¥æ¡†

  view.innerHTML = `
    <div class="detail" data-layout="${isNote ? 'note' : (isRich ? 'rich' : 'image')}">

      <!-- ä¸Šé¢å¤§å›¾ + å·¦å³ç¿»é¡µ -->
      <div class="imgbox" id="detailImgBox"
           style="${detailBg ? 'background-image:url(' + detailBg + ');background-size:cover;background-position:center;' : ''}">
        ${hasPrev ? '<button class="page-nav left" id="btnPrev">&lt;</button>' : ''}
        ${p.img ? `<img src="${p.img}" alt=""/>` : `<div style="color:#999;padding:40px">æš‚æ— å›¾ç‰‡</div>`}
        ${hasNext ? '<button class="page-nav right" id="btnNext">&gt;</button>' : ''}
      </div>

      ${progressHtml}

      <!-- æ ‡é¢˜ -->
      <div class="field" id="detailTitleBlock">
        <small class="muted">æ ‡é¢˜</small>
        <input class="input" id="inpTitle" value="${escapeHtml(p.title || '')}"/>
      </div>

      ${p.layout === 'font' ? `
      <div class="field" id="fontPreviewField">
        <small class="muted">é¢„è§ˆ</small>
        <div id="fontPreview"
             class="input"
             style="min-height:120px;font-size:32px;display:flex;align-items:center;justify-content:center;">
          Abc ä½ å¥½
        </div>
      </div>
      ` : ''}

      <!-- æ ‡ç­¾ + åŠŸèƒ½æŒ‰é’® + æ”¶è—ï¼ˆé˜…è¯»æ¨¡å¼å•ç‹¬ä¸€è¡Œï¼‰ -->
      <div class="field"
           id="detailMetaRow"
           style="display:flex;flex-direction:row;align-items:center;gap:8px;">
        <!-- å·¦ä¾§æ ‡ç­¾è¾“å…¥æ¡† -->
    <input id="inpTags"
               class="input"
               placeholder="æ ‡ç­¾ï¼ˆç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ï¼šæ‰‹å†™ä½“ å›¾ä½“ï¼‰"
               style="flex:1;">

        <!-- å³ä¾§åŠŸèƒ½æŒ‰é’®ä»¬ -->
        <div style="display:flex;align-items:center;gap:6px;">
          <button class="btn" id="btnDetailTools">âš™ åŠŸèƒ½</button>

          <!-- åŠŸèƒ½é¢æ¿ï¼šé»˜è®¤æ”¶èµ· -->
          <div id="imgEditPanel"
               style="display:none;flex-wrap:wrap;gap:4px;max-width:60vw;">
            <button class="btn" id="btnInsertImg"  type="button">ï¼‹ åœ¨å…‰æ ‡å¤„æ’å›¾ç‰‡</button>
            <button class="btn" id="btnToggleImgEdit" type="button">ğŸ–¼ å›¾ç‰‡ç¼–è¾‘ï¼šå…³</button>
            <button class="btn" id="btnResizeMode" type="button">ğŸ” æ”¾å¤§ç¼©å°ï¼šå…³</button>
            <button class="btn" id="btnMoveMode"   type="button">ğŸ•¹ ç§»åŠ¨ï¼šå…³</button>
            <button class="btn" id="btnDeleteImg"   type="button">ğŸ—‘ åˆ é™¤å›¾ç‰‡ï¼šå…³</button>
            <button class="btn" id="btnReplaceMain" type="button">ğŸ–¼ æ¢ä¸»å›¾</button>
            <button class="btn" id="btnSaveImg"     type="button">ğŸ’¾ å›¾ç‰‡å›¾ç‰‡</button>
            <button class="btn" id="btnDeletePage"  type="button">ğŸ—‘ åˆ é™¤æœ¬é¡µ</button>
            <button class="btn" id="btnSetDetailBg" type="button">ğŸŒˆ è®¾è¯¦æƒ…èƒŒæ™¯</button>
            
          </div>

          <!-- æ”¶è— -->
          <button class="btn" id="btnStar">
            ${p.star ? 'â˜… å·²æ”¶è—' : 'â˜† æ”¶è—'}
          </button>
        </div>
      </div>
<!-- é˜…è¯»æ¨¡å¼ï¼šå•ç‹¬å ä¸€è¡Œï¼Œè¿™æ ·å¼€å¯åæŒ‰é’®è¿˜åœ¨ -->
      ${!isFont ? `
      <div class="field"
           id="readingRow"
           style="display:flex;justify-content:flex-end;">
        <button class="btn" id="btnReadingMode">ğŸ“– é˜…è¯»æ¨¡å¼</button>
      </div>
      ` : ''}
      <!-- URLï¼ˆå…³æ‰ï¼‰ -->
      ${showUrlField ? `
      <div class="field">
        <small class="muted">URLï¼ˆæ¯è¡Œä¸€æ¡ï¼‰</small>
        <textarea class="input" id="inpUrls" rows="2">${(p.urls || []).join('\n')}</textarea>
      </div>` : ''}

      <!-- æ­£æ–‡ï¼šrich / æ™®é€šäºŒé€‰ä¸€ -->
    ${!isFont ? (isRich ? `
      <!-- å›¾æ–‡æ··æ’ï¼šæ•´ä½“åŒ…ä¸€å±‚ detailRichFieldï¼Œæ–¹ä¾¿é˜…è¯»æ¨¡å¼ä¸€èµ·éšè—/æ˜¾ç¤º -->
      <div class="field" id="detailRichField">
        <small class="muted">æ­£æ–‡</small>
        <div id="richEditor"
             class="input rich-editor"
             contenteditable="true"
             style="${detailBg ? 'background-image:url(' + detailBg + ');background-size:cover;background-position:center;' : ''}">
          ${p.rich || escapeHtml(p.note || '')}
        </div>
      </div>
      ` : `
      <!-- æ™®é€šå›¾ç‰‡é¡µ / æ–‡å­—é¡µï¼šæ•´ä½“åŒ…ä¸€å±‚ detailNoteField -->
      <div class="field" id="detailNoteField">
        <small class="muted">æ­£æ–‡</small>
        <textarea class="input" id="inpNote" rows="10"
          style="min-height:60vh;${detailBg ? 'background-image:url(' + detailBg + ');background-size:cover;background-position:center;' : ''}">${escapeHtml(p.note || '')}</textarea>
      </div>
      `) : ''}
<!-- note å¸ƒå±€ï¼šå¤šå›¾ç¼©ç•¥å›¾ + æ·»åŠ å›¾ç‰‡ -->
      ${isNote ? `
      <div class="field">
        <small class="muted">å›¾ç‰‡ï¼ˆå¯å¤šå¼ ï¼‰</small>
        <div id="imageBox" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;">
          ${(p.imgList || []).map(img => `
            <img src="${img}"
                 class="thumbnail"
                 style="width:120px;border-radius:6px;cursor:pointer">
          `).join('')}
        </div>
        <button class="btn" id="addImageBtn" type="button">ï¼‹ æ·»åŠ å›¾ç‰‡</button>
      </div>
      ` : ''}

    </div>
  `;
// â­ é‡æ–°è¿›å…¥è¯¦æƒ…é¡µæ—¶ï¼ŒæŠŠä¿å­˜è¿‡çš„æ ‡é¢˜ / æ ‡ç­¾ / æ­£æ–‡ å†™å›è¾“å…¥æ¡†
  const inpTitle = document.getElementById('inpTitle');
  const inpTags  = document.getElementById('inpTags');
  const inpNote  = document.getElementById('inpNote');   // ğŸ†• æ­£æ–‡ textarea

  if (inpTitle) inpTitle.value = p.title || '';
  if (inpTags)  inpTags.value  = (p.tags || []).join(' ');
  if (inpNote)  inpNote.value  = p.note  || '';

  // ğŸ‘‰ æ–°å¢ï¼šæ­£æ–‡è¾“å…¥æ—¶ç«‹åˆ»ä¿å­˜ï¼ˆä¸å†æŒ‡æœ›å¤–é¢çš„å…¨å±€ç›‘å¬ï¼‰
  if (inpNote) {
    inpNote.oninput = function () {
      // å†æ‰¾ä¸€æ¬¡å½“å‰é¡µï¼Œä¿è¯æ‹¿åˆ°çš„å°±æ˜¯æ­£åœ¨ç¼–è¾‘çš„é‚£ä¸€é¡µ
      const alb  = db.albums.find(a => a.id === current.albumId);
      if (!alb) return;
      const page = alb.pages.find(x => x.id === current.pageId);
      if (!page) return;

      page.note    = this.value;     // æŠŠæ­£æ–‡å†™å› page.note
      page.updated = Date.now();
      autosave();                    // ä¸¢ç»™åŸæ¥çš„è‡ªåŠ¨ä¿å­˜é€»è¾‘
    };
  }

  // ====== é¡¶éƒ¨ä¸Šä¸‹é¡µå¯¼èˆª ======
  const prevEl = document.getElementById('btnPrev');
  if (prevEl) prevEl.onclick = ()=>{ navSibling(-1); };

  const nextEl = document.getElementById('btnNext');
  if (nextEl) nextEl.onclick = ()=>{ navSibling(1); };

  // ====== æ”¶è— ======
  const starEl = document.getElementById('btnStar');
  if (starEl) {
    starEl.onclick = ()=>{
      p.star = !p.star;
      p.updated = Date.now();
      autosave();
      render();
    };
  }

  // ====== è¯¦æƒ…é¡µé‡Œçš„ã€Œâš™ åŠŸèƒ½ã€å¼€åˆæŒ‰é’® ======
  const detailToolsBtn = document.getElementById('btnDetailTools');
  const editPanel      = document.getElementById('imgEditPanel');

  if (detailToolsBtn && editPanel) {
    editPanel.style.display = 'none';
    detailToolsBtn.textContent = 'âš™ åŠŸèƒ½';

    detailToolsBtn.onclick = () => {
      const isHidden =
        (editPanel.style.display === 'none' || !editPanel.style.display);
      editPanel.style.display   = isHidden ? 'flex' : 'none';
      detailToolsBtn.textContent = isHidden ? 'âš™ æ”¶èµ·' : 'âš™ åŠŸèƒ½';
    };
  }

  // ====== rich æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆå›¾æ–‡æ··æ’æ¨¡å¼ï¼‰ ======
  const richEditor   = document.getElementById('richEditor');
  const insertBtn    = document.getElementById('btnInsertImg');
  const toggleEdit   = document.getElementById('btnToggleImgEdit');
  const resizeBtn    = document.getElementById('btnResizeMode');
  const moveBtn      = document.getElementById('btnMoveMode');
  const deleteImgBtn = document.getElementById('btnDeleteImg');  // ğŸ†• åˆ é™¤æŒ‰é’®

  // å›¾ç‰‡å­å¼€å…³ï¼ˆæ”¾å¤§/ç§»åŠ¨/åˆ é™¤ï¼‰åœ¨ã€Œå›¾ç‰‡ç¼–è¾‘ã€å…³é—­æ—¶ä¸€èµ·éšè—
  function updateImgSubTools() {
    const show = !!window.__imgEditMode;
    if (resizeBtn)    resizeBtn.style.display    = show ? 'inline-flex' : 'none';
    if (moveBtn)      moveBtn.style.display      = show ? 'inline-flex' : 'none';
    if (deleteImgBtn) deleteImgBtn.style.display = show ? 'inline-flex' : 'none';
  }
  updateImgSubTools();

  // æ–‡æœ¬å†…å®¹æ”¹å˜å°±è‡ªåŠ¨ä¿å­˜
if (richEditor) {
  richEditor.addEventListener('input', () => {
    // è¿™é‡Œç›´æ¥æ‹¿å½“å‰ä¸“è¾‘å’Œå½“å‰é¡µï¼Œä¸å†ç”¨ä¸å­˜åœ¨çš„ getCurrentPage()
    const alb  = db.albums.find(a => a.id === current.albumId);
    if (!alb) return;
    const page = alb.pages.find(x => x.id === current.pageId);
    if (!page) return;

    const html = richEditor.innerHTML;  // ä¿ç•™å®Œæ•´å¯Œæ–‡æœ¬
    const text = richEditor.innerText;  // çº¯æ–‡å­—ç‰ˆ

    // å¯Œæ–‡æœ¬å’Œçº¯æ–‡å­—éƒ½å­˜ä¸€ä»½
    page.rich    = html;
    page.note    = text;
    page.updated = Date.now();
    autosave();
  });


    // åˆ é™¤æ¨¡å¼ï¼šç‚¹å›¾ç‰‡å°±åˆ é™¤
    richEditor.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target instanceof HTMLImageElement)) return;
      if (!window.__imgEditMode || !window.__imgDeleteMode) return;

      // ç›´æ¥ç§»é™¤è¿™å¼ å›¾ç‰‡
      target.remove();
      p.rich = richEditor.innerHTML;
      autosave();
    });
  }

  // é€‰æ‹©å›¾ç‰‡å¹¶æ’å…¥åˆ°å…‰æ ‡å¤„
  if (insertBtn && richEditor) {
    insertBtn.onclick = () => {
      const i = document.createElement('input');
      i.type = 'file';
      i.accept = 'image/*';
      i.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        readFile(file, data => {
          insertImageAtCursor(richEditor, data);
          p.rich = richEditor.innerHTML;
          autosave();
        });
      };
      i.click();
    };
  }

  // ğŸ–¼ å›¾ç‰‡ç¼–è¾‘æ¨¡å¼æ€»å¼€å…³
  if (toggleEdit) {
    toggleEdit.onclick = () => {
      window.__imgEditMode = !window.__imgEditMode;
      toggleEdit.textContent = window.__imgEditMode
        ? 'ğŸ–¼ å›¾ç‰‡ç¼–è¾‘ï¼šå¼€'
        : 'ğŸ–¼ å›¾ç‰‡ç¼–è¾‘ï¼šå…³';

      updateImgSubTools();

      if (window.__imgEditMode) {
        if (editPanel)      editPanel.style.display = 'flex';
        if (detailToolsBtn) detailToolsBtn.textContent = 'âš™ æ”¶èµ·';
      } else {
        window.__imgResizeMode = false;
        window.__imgMoveMode   = false;
        window.__imgDeleteMode = false;
        if (resizeBtn)    resizeBtn.textContent    = 'ğŸ” æ”¾å¤§ç¼©å°ï¼šå…³';
        if (moveBtn)      moveBtn.textContent      = 'ğŸ•¹ ç§»åŠ¨ï¼šå…³';
        if (deleteImgBtn) deleteImgBtn.textContent = 'ğŸ—‘ åˆ é™¤å›¾ç‰‡ï¼šå…³';
        if (editPanel)      editPanel.style.display = 'none';
        if (detailToolsBtn) detailToolsBtn.textContent = 'âš™ åŠŸèƒ½';
      }
    };
  }

  // å­å¼€å…³ï¼šæ”¾å¤§ç¼©å° / ç§»åŠ¨
  if (resizeBtn) {
    resizeBtn.onclick = () => {
      window.__imgResizeMode = !window.__imgResizeMode;
      resizeBtn.textContent = window.__imgResizeMode
        ? 'ğŸ” æ”¾å¤§ç¼©å°ï¼šå¼€'
        : 'ğŸ” æ”¾å¤§ç¼©å°ï¼šå…³';
    };
  }

  if (moveBtn) {
    moveBtn.onclick = () => {
      window.__imgMoveMode = !window.__imgMoveMode;
      moveBtn.textContent = window.__imgMoveMode
        ? 'ğŸ•¹ ç§»åŠ¨ï¼šå¼€'
        : 'ğŸ•¹ ç§»åŠ¨ï¼šå…³';
    };
  }

  // ğŸ—‘ åˆ é™¤å›¾ç‰‡æ¨¡å¼å¼€å…³
  if (deleteImgBtn) {
    deleteImgBtn.onclick = () => {
      if (!window.__imgEditMode) {
        toast('detailMsg', 'è¯·å…ˆæ‰“å¼€ã€Œå›¾ç‰‡ç¼–è¾‘ã€å†åˆ å›¾ç‰‡å™¢ï½');
        return;
      }
      window.__imgDeleteMode = !window.__imgDeleteMode;
      deleteImgBtn.textContent = window.__imgDeleteMode
        ? 'ğŸ—‘ åˆ é™¤å›¾ç‰‡ï¼šå¼€'
        : 'ğŸ—‘ åˆ é™¤å›¾ç‰‡ï¼šå…³';
    };
  }
/* ====== è¯¦æƒ…é¡µï¼šä¸»å›¾å››æŒ‰é’®åŠŸèƒ½ç»‘å®š ====== */
  const btnReplace = document.getElementById('btnReplaceMain');
  const btnSave = document.getElementById('btnSaveImg');
  const btnDel = document.getElementById('btnDeleteImg');
  const btnBg = document.getElementById('btnSetDetailBg');

  function getCurrent(){
    const alb = db.albums.find(a => a.id === current.albumId);
    if(!alb) return {};
    const page = alb.pages.find(p => p.id === current.pageId);
    return {alb,page};
  }

  // ğŸ–¼ æ¢ä¸»å›¾
  if(btnReplace){
    btnReplace.onclick = ()=>{
      const {alb,page} = getCurrent();
      if(!page)return alert("æ²¡æœ‰å½“å‰é¡µï¼");
      const input = document.createElement("input");
      input.type="file";
      input.accept="image/*";
      input.onchange = e=>{
        const file = e.target.files[0];
        if(!file)return;
        const reader=new FileReader();
        reader.onload = ev=>{
          page.img = ev.target.result;
          autosave();
          render();
          alert("ä¸»å›¾å·²æ›¿æ¢ï¼");
        };
        reader.readAsDataURL(file);
      };
      input.click();
    };
  }

  // ğŸ’¾ ä¿å­˜å›¾ç‰‡
  if(btnSave){
    btnSave.onclick = ()=>{
      const {page} = getCurrent();
      if(!page || !page.img)return alert("å½“å‰é¡µæ²¡æœ‰å›¾ç‰‡ï¼");
      const a=document.createElement("a");
      a.href=page.img;
      a.download="flipbook-img.jpg";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };
  }

// ğŸŒˆ è®¾è¯¦æƒ…èƒŒæ™¯ï¼šç‚¹ä¸€ä¸‹å¼¹å‡ºé€‰å›¾ï¼Œä»ç›¸å†Œé€‰ä¸€å¼ å½“è¯¦æƒ…èƒŒæ™¯
if (btnBg) {
  btnBg.onclick = ()=>{
    const {alb} = getCurrent();
    if (!alb) {
      alert('æ²¡æœ‰å½“å‰ä¸“è¾‘ï¼');
      return;
    }
    // åƒâ€œè®¾å°é¢ / è®¾èƒŒæ™¯â€é‚£æ ·ï¼Œä»ç›¸å†Œé€‰å›¾
    pickImage((data)=>{
      const cur = getCurrent();
      if(!cur || !cur.page) return;
      cur.page.bgDetail = data;
      autosave();
      alert('å·²è®¾ä¸ºæœ¬é¡µè¯¦æƒ…èƒŒæ™¯ï¼');
      render();
    });
  };
}
// ğŸ—‘ åˆ é™¤æœ¬é¡µæŒ‰é’®ï¼ˆä¸å†ä¾èµ– toastï¼Œåªç”¨ alertï¼‰
const btnDeletePage = document.getElementById('btnDeletePage');
if (btnDeletePage) {
  btnDeletePage.onclick = ()=>{
    const {alb,page} = getCurrent();
    if (!page) {
      alert('æ²¡æœ‰å½“å‰é¡µï¼');
      return;
    }
    if (confirm('ç¡®å®šåˆ é™¤å½“å‰é¡µå—ï¼Ÿ')) {
      const idx = alb.pages.indexOf(page);
      if (idx >= 0) alb.pages.splice(idx, 1);
      autosave();
      render();
      alert('å½“å‰é¡µå·²åˆ é™¤ï½');
    }
  };
}
  // ====== note å¸ƒå±€ï¼šå¤šå›¾ä¸Šä¼  ======
  const addImageBtn = document.getElementById('addImageBtn');
  const imageBox    = document.getElementById('imageBox');
  if (addImageBtn && imageBox) {
    addImageBtn.onclick = ()=>{
      const i = document.createElement('input');
      i.type = 'file';
      i.accept = 'image/*';
      i.multiple = true;
      i.onchange = (e)=>{
        const files = Array.from(e.target.files || []);
        files.forEach(file=>{
          readFile(file, data=>{
            p.imgList = p.imgList || [];
            p.imgList.push(data);
            if (!p.img) p.img = data;
            const img = document.createElement('img');
            img.src = data;
            img.className = 'thumbnail';
            img.style.width = '120px';
            img.style.borderRadius = '6px';
            img.style.cursor = 'pointer';
            imageBox.appendChild(img);
            p.updated = Date.now();
            autosave();
          });
        });
      };
      i.click();
    };
  }

// ====== é˜…è¯»æ¨¡å¼ï¼šæ”¶èµ·ä¸Šé¢ä¸€å †ï¼Œåªç•™æ­£æ–‡ ======
const titleBlock = document.getElementById('detailTitleBlock');
const metaRow    = document.getElementById('detailMetaRow');
const readingBtn = document.getElementById('btnReadingMode');
const noteField  = document.getElementById('detailNoteField');
const richField  = document.getElementById('detailRichField');

// ä¸å†åŒºåˆ†ä»€ä¹ˆ image / note / richï¼Œæ­£æ–‡æ°¸è¿œèƒ½çœ‹åˆ°
function applyReadingMode() {
  const on = !!current.readingMode;

  // ä¸Šé¢çš„æ ‡é¢˜ + æ ‡ç­¾ + æŒ‰é’®
  if (titleBlock) titleBlock.style.display = on ? 'none' : 'block';
  if (metaRow)    metaRow.style.display    = on ? 'none' : 'flex';

  // æ­£æ–‡åŒºåŸŸä¸€ç›´ä¿æŒå¯è§
  if (noteField) {
    noteField.style.display = 'block';
    noteField.style.pointerEvents = 'auto';
  }
  if (richField) {
    richField.style.display = 'block';
    richField.contentEditable = 'true';
    richField.style.pointerEvents = 'auto';
  }

  if (readingBtn) {
    readingBtn.textContent = on ? 'ğŸ“– é€€å‡ºé˜…è¯»' : 'ğŸ“– é˜…è¯»æ¨¡å¼';
  }
}
applyReadingMode();

if (readingBtn) {
  readingBtn.onclick = () => {
    current.readingMode = !current.readingMode;
    applyReadingMode();
  };
}
  // ====== è¯¦æƒ…é¡µèƒŒæ™¯ ======
  document.body.style.backgroundImage =
    detailBg
      ? `url(${detailBg})`
      : '';

  // å­—ä½“é¢„è§ˆé¡µï¼šåˆå§‹åŒ–ä¸€æ¬¡å­—ä½“
  if (isFont && Array.isArray(p.urls) && p.urls.length > 0) {
    applyUrlPreview(p.urls[0]);
  }

 }else if(current.view==='favs'){
  titleEl.textContent='æˆ‘çš„æ”¶è— â˜…';
  btnBack.style.display='inline-block';
  const favs=[]; db.albums.forEach(a=>a.pages.forEach(p=>{ if(p.star) favs.push({a,p}) }));

  const size = db.meta.thumbSize || 'm';

  view.innerHTML=`
    <div class="row" style="margin-bottom:10px">
      <div class="spacer"></div>
      <button class="btn" id="switchView">åˆ‡æ¢ï¼š${current.results?'åˆ—è¡¨':'ç½‘æ ¼'}</button>
    </div>
    ${current.results
      ? favList(favs)
      : `<div class="grid thumb-grid thumb-${size}">${favs.map(({a,p})=>thumb(p,a,true)).join('')}</div>`
    }
  `;
    document.getElementById('switchView').onclick=()=>{ current.results = current.results?null:[]; render(); };
  }

  // ç»‘å®šè¿”å›
  btnBack.onclick = () => {
  if (current.view === 'detail') {
    current.view = 'album';
    current.readingMode = false;  // é€€å‡ºè¯¦æƒ…é¡ºä¾¿å…³é˜…è¯»æ¨¡å¼
    render();
  } else {
    current.view = 'home';
    render();
  }
};
}
// åŒ…ä¸€å±‚ï¼šæ¯æ¬¡ render å®Œæˆåï¼Œé¡ºä¾¿å¹²ä¸¤ä»¶äº‹ï¼š
// 1ï¼‰æ§åˆ¶å³ä¸‹è§’ã€Œï¼‹ã€æ˜¾ç¤ºï¼›
// 2ï¼‰å¦‚æœæ˜¯å›¾æ–‡æ··æ’é¡µï¼ŒæŠŠå·²ç»ä¿å­˜çš„ rich æ–‡æœ¬å¡å›ç¼–è¾‘å™¨é‡Œã€‚
const _render = render;
render = function () {
  // å…ˆè®©åŸæ¥çš„æ¸²æŸ“è·‘å®Œ
  _render();

  // â˜… ä¿®ï¼šå›¾æ–‡æ··æ’ï¼ˆlayout === 'rich'ï¼‰æ¢å¤æ­£æ–‡å†…å®¹
  if (current.view === 'detail') {
    const richEditor = document.getElementById('richEditor');
    if (richEditor) {
      const alb = db.albums.find(a => a.id === current.albumId);
      if (alb) {
        const p = alb.pages.find(x => x.id === current.pageId);
        if (p && p.layout === 'rich') {
          // ä¼˜å…ˆç”¨ p.richï¼ˆå¯Œæ–‡æœ¬ï¼‰ï¼Œæ²¡æœ‰çš„è¯å°±ç”¨ p.note å…œåº•
          if (p.rich && p.rich.trim()) {
            richEditor.innerHTML = p.rich;
          } else if (p.note && p.note.trim()) {
            // æ—§æ•°æ®åªæœ‰ note çš„æƒ…å†µï¼Œå…ˆç”¨çº¯æ–‡æœ¬å¡«è¿›å»
            richEditor.textContent = p.note;
          }
        }
      }
    }
  }

  // â˜… åŸæ¥çš„ï¼šæ§åˆ¶å³ä¸‹è§’ã€Œï¼‹ã€
  const fab = document.getElementById('fab');
  if (!fab) return;

  // åªåœ¨é¦–é¡µ / ä¸“è¾‘é¡µæ˜¾ç¤ºåŠ å·ï¼Œå…¶ä»–é¡µé¢ï¼ˆè¯¦æƒ… / æ”¶è—ï¼‰å…¨éƒ¨è—èµ·æ¥
  if (current.view === 'home' || current.view === 'album') {
    fab.style.display = 'flex';
  } else {
    fab.style.display = 'none';
  }
};
function listInScope(alb){ return alb.pages.filter(p=>!current.onlyStar || p.star); }
function navSibling(dir){
  const alb = db.albums.find(a=>a.id===current.albumId);
  const scope=listInScope(alb);
  const idx = scope.findIndex(p=>p.id===current.pageId);
  const target = scope[idx+dir];
  if(target){ current.pageId=target.id; render(); }
}

function albumCard(a){
  // ä¼˜å…ˆç”¨å°é¢ï¼Œå…¶æ¬¡ç”¨ç½‘æ ¼èƒŒæ™¯ï¼Œæœ€åæ‰ç”¨é»˜è®¤æ¸å˜
  const bg = a.cover || a.bgGrid;

// å°æ ‡ç­¾ï¼šä¼˜å…ˆæ˜¾ç¤ºä½ è‡ªå®šä¹‰çš„ç±»å‹
  let label = a.type || 'ä¸“è¾‘';
  // ä»…å…¼å®¹æ—§æ•°æ®
  if (a.type === 'fonts')   label = 'å­—ä½“ä¸“è¾‘';
  else if (a.type === 'article') label = 'æ–‡ç« æœ¬';
  else if (a.type === 'url')     label = 'ç½‘å€æœ¬';

  return `<div class="card" onclick="enterAlbum('${a.id}')">
    <div class="cover" style="background-image:${bg ? `url(${bg})` : `linear-gradient(135deg, #f6d 0%, #9cf 100%)`};">
      <div class="label">${label}</div>
      <button class="card-menu-btn" onclick="event.stopPropagation(); openEditAlbum('${a.id}')">â‹¯</button>
    </div>
    <div class="body">
      <div class="row">
        <div class="name">${escapeHtml(a.name)}</div>
        <div class="spacer"></div>
        <div class="sub">${a.pages.length} é¡µ</div>
      </div>
      <div class="sub">æœ€è¿‘ï¼š${a.pages.length ? new Date(a.pages[a.pages.length - 1].updated || Date.now()).toLocaleDateString() : 'â€”'}</div>
    </div>
  </div>`;
}

function thumb(p, alb, showAlbum){
  const tags = (p.tags||[]).slice(0,3).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('');
  const isFontLayout = p.layout === 'font';
  let imgHtml = '';
  if (isFontLayout) {
    const firstUrl = (p.urls && p.urls[0]) || '';
    const clean = (firstUrl.split('?')[0] || '').toLowerCase();
    const looksLikeFont = /\.(ttf|otf|woff2?)$/.test(clean);
    if (firstUrl && !looksLikeFont) {
      // å›¾ç‰‡ç±»ï¼šç›´æ¥ç”¨ URL åšå°é¢
      imgHtml = `<div class="img" style="background-image:url(${firstUrl})"></div>`;
    } else {
      // å­—ä½“ç±»ï¼šç”¨æ–‡å­—é¢„è§ˆï¼Œåé¢ç”¨ JS å¥—å­—ä½“
      imgHtml = `<div class="img font-thumb" data-url="${firstUrl ? escapeHtml(firstUrl) : ''}">
        <span class="font-sample">Abc ä½ å¥½</span>
      </div>`;
    }
  } else {
    imgHtml = `<div class="img" style="background-image:${p.img ? `url(${p.img})` : `linear-gradient(135deg,#eee,#ddd)`}"></div>`;
  }

  return `<div class="thumb" onclick="openPage('${alb.id}','${p.id}')">
    ${imgHtml}
    <button class="star ${p.star ? 'on' : ''}" onclick="event.stopPropagation();toggleStar('${alb.id}','${p.id}')">${p.star ? 'â˜…' : 'â˜†'}</button>
    <div class="meta">
      <div class="row">
        <div class="name" style="font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
          ${escapeHtml(p.title || 'æ— æ ‡é¢˜')}
          ${showAlbum ? `<span class="sub"> Â· ${escapeHtml(alb.name)}</span>` : ''}
        </div>
      </div>
      <div class="chips">${tags}</div>
    </div>
  </div>`;
}
function favList(favs){
  return `<div class="list">${favs.map(({a,p})=>`
    <div class="item" onclick="openPage('${a.id}','${p.id}')">
      <div class="mini" style="background-image:${p.img?`url(${p.img})`:'linear-gradient(135deg,#eee,#ddd)'}"></div>
      <div class="txt">
        <div class="t">${escapeHtml(p.title||'æ— æ ‡é¢˜')} <span class="sub">| ${escapeHtml(a.name)}</span></div>
        <div class="sub">${snippet(p)}</div>
      </div>
    </div>`).join('')}</div>`;
}
 /* ===== äº¤äº’ ===== */
function enterAlbum(aid){
  current.view = 'album';
  current.albumId = aid;
  current.onlyStar = false;
  current.tagFilter = null;   // â­ æ¯æ¬¡è¿›ä¸“è¾‘å…ˆæ¸…ç©ºæ ‡ç­¾ç­›é€‰
  current.readingMode = false; // è¿›ä¸“è¾‘æ—¶å…³æ‰é˜…è¯»æ¨¡å¼
  render();
}
function openPage(aid,pid){
  current.view = 'detail';
  current.albumId = aid;
  current.pageId = pid;
  current.readingMode = false;   // æ¯æ¬¡æ‰“å¼€æ–°é¡µé»˜è®¤æ­£å¸¸æ¨¡å¼
  render();
}
function toggleStar(aid,pid){ const a=db.albums.find(x=>x.id===aid); const p=a.pages.find(x=>x.id===pid); p.star=!p.star; p.updated=Date.now(); autosave(); render(); }
// é¡¶æ ä¸»é¢˜ï¼ˆå†…è”æŒ‰é’®ï¼Œä¸ç”¨æŠ½å±‰/é®ç½©ï¼‰
document.body.addEventListener('click',e=>{
  if(e.target && e.target.dataset && e.target.dataset.themeInline){
    const t=e.target.dataset.themeInline; db.meta.theme=t; autosave(); applyTheme();
  }
});

// Inline æœç´¢æ¡
(function(){
  const input = document.getElementById('searchInputInline');
  const box = document.getElementById('searchResultInline');
  if(input){
    input.addEventListener('input', (e)=>{
      const q=e.target.value.trim();
      const out = search(q);
      box.innerHTML = out.map(r=>`<div class="item" onclick="openPage('${r.a.id}','${r.p.id}')">
        <div class="mini" style="background-image:${r.p.img?`url(${r.p.img})`:'linear-gradient(135deg,#eee,#ddd)'}"></div>
        <div class="txt">
          <div class="t">${hl(escapeHtml(r.p.title||'æ— æ ‡é¢˜'), r._kw)} <span class="sub">| ${escapeHtml(r.a.name)}</span></div>
          <div class="sub">${r._snippet}</div>
        </div>
      </div>`).join('');
    });
  }
})();

// æœç´¢æ ¸å¿ƒï¼ˆå…¨åº“ï¼‰
function search(q){
  const kws = parseQuery(q);
  const res=[];
  db.albums.forEach(a=>a.pages.forEach(p=>{
    const hay = {
      title: p.title||'',
      note: (p.note || p.rich || ''),
      tags: (p.tags||[]).join(' '),
      urls: (p.urls||[]).join(' ')
    };
    if(match(hay, kws)){ res.push({a,p,_kw:kws.keyword,_snippet:makeSnippet(hay, kws)}); }
  }));
  return res;
}
function parseQuery(q){
  const o={keyword:'', tag:null, url:null, title:null, star:false, phrase:null, not:[]};
  if(!q) return o;
  const m=q.match(/"([^"]+)"/); if(m){ o.phrase=m[1]; q=q.replace(m[0],''); }
  q.split(/\s+/).filter(Boolean).forEach(tok=>{
    if(/^tag:/.test(tok)) o.tag = tok.slice(4);
    else if(/^url:/.test(tok)) o.url = tok.slice(4);
    else if(/^title:/.test(tok)) o.title = tok.slice(6);
    else if(/^-\w+/.test(tok)) o.not.push(tok.slice(1));
    else if(tok==='â˜…'||tok==='star:true') o.star=true;
    else o.keyword += ' '+tok;
  });
  o.keyword=o.keyword.trim();
  return o;
}
function match(h, k){
  if(k.tag && !h.tags.includes(k.tag)) return false;
  if(k.url && !h.urls.toLowerCase().includes(k.url.toLowerCase())) return false;
  if(k.title && !h.title.toLowerCase().includes(k.title.toLowerCase())) return false;
  const pool = (h.title+' '+h.tags+' '+h.urls+' '+h.note).toLowerCase();
  if(k.phrase && !pool.includes(k.phrase.toLowerCase())) return false;
  if(k.keyword && !pool.includes(k.keyword.toLowerCase())) return false;
  for(const n of k.not){ if(pool.includes(n.toLowerCase())) return false; }
  return true;
}
function makeSnippet(h,k){
  const pool = (h.title+' '+h.tags+' '+h.urls+' '+h.note);
  const key = k.phrase || k.keyword || k.tag || k.url || k.title;
  if(!key){ return escapeHtml(h.note.slice(0,80)); }
  const idx = pool.toLowerCase().indexOf(key.toLowerCase());
  if(idx<0) return escapeHtml(pool.slice(0,80));
  const start=Math.max(0, idx-20), end=Math.min(pool.length, idx+20);
  const seg = pool.slice(start,end);
  return hl(escapeHtml(seg), key);
}
function snippet(p){ 
  const h={title:p.title||'', tags:(p.tags||[]).join(' '), urls:(p.urls||[]).join(' '), note:(p.note || p.rich || '')};
  return escapeHtml((h.note||h.title).slice(0,80));
}
 function hl(txt, kw){
  if(!kw) return txt;
  try{
    const re=new RegExp('('+kw.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&')+')','ig');
    return txt.replace(re,'<span class="hl">$1</span>');
  }catch(e){ return txt; }
}
function escapeHtml(s){ return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
/* ===== é€‰æ‹©å™¨/æ–‡ä»¶è¯»å–ï¼ˆå¸¦å‹ç¼©ï¼‰ ===== */

// é€šç”¨å‹ç¼©å‡½æ•°ï¼šæŠŠå›¾ç‰‡å‹åˆ°æœ€é•¿è¾¹ä¸è¶…è¿‡ 1280 åƒç´ ï¼Œè½¬æˆ jpeg å†ä¿å­˜
function compressImage(file, maxSize, cb){
  const reader = new FileReader();
  reader.onload = (e) =>{
    const img = new Image();
    img.onload = () =>{
      let w = img.width;
      let h = img.height;
      const max = maxSize || 1280;

      if (w > h && w > max){
        h = Math.round(h * max / w);
        w = max;
      } else if (h >= w && h > max){
        w = Math.round(w * max / h);
        h = max;
      }

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      // ğŸ‘‰ åˆ†æƒ…å†µè°ƒè´¨é‡ï¼šèƒŒæ™¯å›¾æ›´å¤§ä¸€ç‚¹ã€è´¨é‡ç¨é™ä¸€ç‚¹
      let quality = 0.8;
      if (max >= 1600) quality = 0.75;

      const dataUrl = canvas.toDataURL('image/jpeg', quality);
      cb(dataUrl);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// é€‰ä¸€å¼ å›¾ï¼ˆå°é¢ / èƒŒæ™¯ ä¼šç”¨åˆ°ï¼‰
function pickImage(cb){
  const i = document.createElement('input');
  i.type = 'file';
  i.accept = 'image/*';
  i.onchange = (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    // ğŸ‘‰ å°é¢ / èƒŒæ™¯ä¸“ç”¨ï¼šæœ€é•¿è¾¹ 1600ï¼Œæ¸…æ™°ä¸€ç‚¹
    compressImage(file, 1600, cb);
  };
  i.click();
}
// åœ¨ contenteditable ç¼–è¾‘å™¨çš„å…‰æ ‡å¤„æ’å…¥ä¸€å¼ å›¾ç‰‡
function insertImageAtCursor(editor, dataUrl){
  if (!editor) return;
  const img = document.createElement('img');
  img.src = dataUrl;
  img.className = 'inline-img';

  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) {
    // æ²¡æœ‰é€‰åŒºå°±ç›´æ¥æ’åˆ°æœ€å
    editor.appendChild(img);
    editor.appendChild(document.createElement('br'));
    return;
  }

  const range = sel.getRangeAt(0);
  // é™åˆ¶æ’å…¥èŒƒå›´åœ¨å½“å‰ç¼–è¾‘å™¨é‡Œ
  if (!editor.contains(range.commonAncestorContainer)) {
    editor.appendChild(img);
    editor.appendChild(document.createElement('br'));
    return;
  }

  range.deleteContents();
  range.insertNode(img);

  // åœ¨å›¾ç‰‡åé¢åŠ ä¸€ä¸ªæ¢è¡Œï¼Œæ–¹ä¾¿ç»§ç»­æ‰“å­—
  const br = document.createElement('br');
  range.setStartAfter(img);
  range.collapse(false);
  range.insertNode(br);

  sel.removeAllRanges();
  const newRange = document.createRange();
  newRange.setStartAfter(br);
  newRange.collapse(true);
  sel.addRange(newRange);
}

// é€‰å¤šå¼ å›¾ï¼ˆå¯¼å…¥å¾ˆå¤šé¡µçš„æ—¶å€™ç”¨ï¼‰
function pickImages(cb){
  const i = document.createElement('input');
  i.type = 'file';
  i.accept = 'image/*';
  i.multiple = true;
  i.onchange = async (e)=>{
    const files = Array.from(e.target.files || []);
    const arr = [];
    for(const f of files){
      await new Promise(res=>{
        compressImage(f, 1280, data=>{
          arr.push(data);
          res();
        });
      });
    }
    cb(arr);
  };
  i.click();
}

// æ›¿æ¢å•å¼ å›¾ç‰‡æ—¶ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªï¼ˆç»™è¯¦æƒ…é¡µï¼‰
function readFile(file, cb){
  compressImage(file, 1280, cb);
}
// æŠŠå½“å‰é¡µå›¾ç‰‡ä¿å­˜æˆæ–‡ä»¶ï¼ˆä¸‹è½½åˆ°æœ¬åœ°ï¼‰
function downloadDataUrl(dataUrl, filename){
  if (!dataUrl) {
    alert('è¿™é¡µè¿˜æ²¡æœ‰å›¾ç‰‡å“¦ï½');
    return;
  }
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename || 'moxie-page.jpg';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}
// ===== æ–°å»º / ç¼–è¾‘ / åˆ é™¤ä¸“è¾‘ å¼¹çª—ç›¸å…³ =====

// æ‰“å¼€ â€œæ–°å»ºä¸“è¾‘â€ æˆ– â€œç¼–è¾‘ä¸“è¾‘â€ å¼¹çª—
// aid ä¸ºç©º = æ–°å»ºï¼›æœ‰å€¼ = ç¼–è¾‘è¿™æœ¬
function openNewAlbumDialog(aid) {
  const dlg      = document.getElementById('dlgNewAlbum');
  const nameI    = document.getElementById('dlgAlbName');
  const typeI    = document.getElementById('dlgAlbType');
  const titleEl  = document.getElementById('dlgAlbTitle');
  const delBtn   = document.getElementById('dlgDelete');

  if (!dlg) return;

  if (aid) {
    // ç¼–è¾‘æ¨¡å¼
    currentAlbumEditId = aid;
    const alb = db.albums.find(a => a.id === aid);
    if (!alb) return;

    if (titleEl) titleEl.textContent = 'ç¼–è¾‘ä¸“è¾‘';
    if (nameI)   nameI.value = alb.name || '';
    if (typeI)   typeI.value = alb.type || '';

    if (delBtn) delBtn.style.display = 'inline-block';
  } else {
    // æ–°å»ºæ¨¡å¼
    currentAlbumEditId = null;
    if (titleEl) titleEl.textContent = 'æ–°å»ºä¸“è¾‘';
    if (nameI)   nameI.value = '';
    if (typeI)   typeI.value = 'å­—ä½“ä¸“è¾‘';   // é»˜è®¤ç»™ä½ ä¸€ä¸ª

    if (delBtn) delBtn.style.display = 'none';
  }

  dlg.style.display = 'flex';
  if (nameI) setTimeout(() => nameI.focus(), 0);
}
function quickAlbType(text){
  const input = document.getElementById('dlgAlbType');
  if (input){
    input.value = text;
    input.focus();
  }
}
// å¡ç‰‡ä¸Šçš„ â‹¯ æŒ‰é’®ï¼šç›´æ¥æ‰“å¼€ç¼–è¾‘
function openEditAlbum(aid){
  openNewAlbumDialog(aid);
}

// ç‚¹ â€œå–æ¶ˆâ€
function onNewAlbumCancel() {
  const dlg = document.getElementById('dlgNewAlbum');
  if (dlg) dlg.style.display = 'none';
  currentAlbumEditId = null;
}

// ç‚¹ â€œç¡®è®¤â€
function onNewAlbumOk() {
  const dlg    = document.getElementById('dlgNewAlbum');
  const nameI  = document.getElementById('dlgAlbName');
  const typeI  = document.getElementById('dlgAlbType');

  const name = (nameI && nameI.value.trim()) ? nameI.value.trim() : 'æ–°ä¸“è¾‘';
  const type = (typeI && typeI.value.trim()) ? typeI.value.trim() : 'ä¸“è¾‘';

  if (currentAlbumEditId) {
    // ç¼–è¾‘å·²æœ‰ä¸“è¾‘
    const alb = db.albums.find(a => a.id === currentAlbumEditId);
    if (alb) {
      alb.name = name;
      alb.type = type;
    }
  } else {
    // æ–°å»ºä¸“è¾‘
    db.albums.push({
      id:       id(),
      name:     name,
      type:     type,
      cover:    null,
      bgGrid:   null,
      bgDetail: null,
      pages:    []
    });
  }

  autosave();
  current.view    = 'home';
  current.albumId = null;
  currentAlbumEditId = null;
  render();

  if (dlg) dlg.style.display = 'none';
}

// ç‚¹ â€œåˆ é™¤ä¸“è¾‘â€
function onDeleteAlbum() {
  if (!currentAlbumEditId) return;
  const alb = db.albums.find(a => a.id === currentAlbumEditId);
  if (!alb) return;

  if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¸“è¾‘ã€Œ${alb.name || ''}ã€å—ï¼Ÿé‡Œé¢çš„é¡µé¢ä¹Ÿä¼šä¸€èµ·åˆ é™¤å“¦ï½`)) return;

  db.albums = db.albums.filter(a => a.id !== currentAlbumEditId);
  currentAlbumEditId = null;

  autosave();
  current.view    = 'home';
  current.albumId = null;
  render();

  const dlg = document.getElementById('dlgNewAlbum');
  if (dlg) dlg.style.display = 'none';
}
// ===== å¤‡ä»½ / å¯¼å…¥å¤‡ä»½ =====

// å¯¼å‡ºå½“å‰å…¨éƒ¨æ•°æ®ä¸º JSON æ–‡ä»¶
function exportBackup(){
  try{
    const data = JSON.stringify(db, null, 2);  // æŠŠç°åœ¨æ‰€æœ‰ä¸“è¾‘+é¡µé¢æ‰“åŒ…
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const date = new Date().toISOString().slice(0,10);
    a.download = 'moxie_books_backup_' + date + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    alert('âœ… å·²å¯¼å‡ºå¤‡ä»½æ–‡ä»¶\nè®°å¾—æ”¾åˆ°å®‰å…¨çš„æ–‡ä»¶å¤¹é‡Œå“¦ï½');
  }catch(e){
    console.error(e);
    alert('å¯¼å‡ºå¤±è´¥äº† QAQ');
  }
}

// ä» JSON æ–‡ä»¶é‡Œå¯¼å…¥å¤‡ä»½
function importBackup(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        const obj = JSON.parse(ev.target.result);
        if(!obj || !obj.albums || !Array.isArray(obj.albums)){
          alert('è¿™ä¸ªæ–‡ä»¶ä¸åƒæ˜¯æœ‰æ•ˆçš„ Moxie Books å¤‡ä»½å‘€â€¦');
          return;
        }
        if(!confirm('ç¡®å®šç”¨è¿™ä¸ªå¤‡ä»½è¦†ç›–å½“å‰æ•°æ®å—ï¼Ÿ\nï¼ˆå½“å‰é¡µé¢é‡Œçš„å†…å®¹ä¼šè¢«å¤‡ä»½é‡Œçš„æ›¿æ¢ï¼‰')){
          return;
        }
        db = obj;
        save();   // å†™å› localStorage
        current = {view:'home', albumId:null, pageId:null, onlyStar:false, results:null};
        render();
        alert('âœ… å·²æˆåŠŸå¯¼å…¥å¤‡ä»½ï¼');
      }catch(err){
        console.error(err);
        alert('è§£æå¤‡ä»½å¤±è´¥äº†ï¼Œå¯èƒ½æ–‡ä»¶æŸåæˆ–ä¸æ˜¯å¤‡ä»½æ–‡ä»¶â€¦');
      }
    };
    reader.readAsText(file, 'utf-8');
  };
  input.click();
}
// é¡¶æ å°é½¿è½®ï¼šå±•å¼€ / æ”¶èµ·ä¸‹é¢é‚£æ’â€œæœç´¢ / æ”¶è— / ä¸»é¢˜ / å£çº¸â€
function toggleTools(){
  const bar = document.getElementById('toolsBar');
  if (!bar) return;
  bar.style.display =
    (bar.style.display === 'none' || bar.style.display === '')
      ? 'block'
      : 'none';
}

// è®¾é¦–é¡µèƒŒæ™¯ï¼šé€‰å›¾å¹¶ä¿å­˜
const btnHomeBg = document.getElementById('btnSetHomeBg');
if (btnHomeBg) {
  btnHomeBg.onclick = () => {
    pickImage(data => {
      db.meta = db.meta || {};
      db.meta.bgs = db.meta.bgs || {};
      db.meta.bgs.home = data;   // å­˜åˆ°é¦–é¡µèƒŒæ™¯å­—æ®µ
      save();                    // ä¿å­˜åˆ° localStorage

      document.body.style.backgroundImage = `url(${data})`;
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundAttachment = 'fixed';
      alert("âœ… å·²è®¾ç½®é¦–é¡µèƒŒæ™¯ï¼");
    });
  };
}
// æ‰“å¼€ / å…³é—­ GitHub å¤‡ä»½é¢æ¿
function openGithubPanel() {
  const mask = document.getElementById('ghPanelMask');
  if (!mask) return;
  mask.style.display = 'flex';
}

function closeGithubPanel() {
  const mask = document.getElementById('ghPanelMask');
  if (!mask) return;
  mask.style.display = 'none';
}

// è‡ªåŠ¨å¤‡ä»½å‹¾é€‰å˜åŒ–æ—¶ï¼Œé¡ºä¾¿å­˜ä¸€ä¸‹é…ç½®
function onGhAutoChange() {
  if (typeof saveGhConfig === 'function') {
    saveGhConfig();
  }
}

// é¢‘ç‡ä¸‹æ‹‰å˜åŒ–ï¼šç«‹åˆ»ç”¨æ–°é¢‘ç‡é‡æ–°ç®—
function onGhIntervalChange() {
  ghLastBackup = 0; // æ¢äº†é¢‘ç‡ï¼Œä¸‹æ¬¡æœ‰æ”¹åŠ¨å°±æŒ‰æ–°é¢‘ç‡
  if (typeof saveGhConfig === 'function') {
    saveGhConfig();
  }
}

// æŠŠ '10m' / '1h' / '3h' / '1d' æ¢æˆæ¯«ç§’
function ghIntervalMs(interval) {
  switch (interval) {
    case '1h': return 60 * 60 * 1000;
    case '3h': return 3 * 60 * 60 * 1000;
    case '1d': return 24 * 60 * 60 * 1000;
    case '10m':
    default:   return 10 * 60 * 1000;
  }
}

/* ===== GitHub äº‘å¤‡ä»½ ===== */

// é…ç½®å­˜åœ¨æœ¬åœ°ï¼Œæ–¹ä¾¿è‡ªåŠ¨å¸¦å‡º
const GH_CFG_KEY = 'moxie_github_cfg_v1';
let ghAutoTimer = null;
let ghLastBackup = 0;

// è¯»è®¾ç½®é¡µé‡Œçš„é…ç½®
function getGhConfig() {
  const token = (document.getElementById('ghToken')?.value || '').trim();
  const owner = (document.getElementById('ghOwner')?.value || '').trim();
  const repo  = (document.getElementById('ghRepo') ?.value || '').trim();
  const path  = (document.getElementById('ghPath') ?.value || '').trim() || 'moxie-diary.json';
  const auto  = !!document.getElementById('ghAuto')?.checked;
  const interval = (document.getElementById('ghInterval')?.value || '10m');

  return { token, owner, repo, path, auto, interval };
}

// æŠŠé…ç½®å­˜åˆ° localStorageï¼Œå¯åŠ¨æ—¶å¯ä»¥æ¢å¤
function saveGhConfig() {
  const cfg = getGhConfig();
  try { localStorage.setItem(GH_CFG_KEY, JSON.stringify(cfg)); } catch(e) {}
}

// é¡µé¢å¯åŠ¨æ—¶æŠŠé…ç½®æ¢å¤åˆ°è¾“å…¥æ¡†
function loadGhConfig() {
  try {
    const raw = localStorage.getItem(GH_CFG_KEY);
    if (!raw) return;
    const cfg = JSON.parse(raw);
    if (cfg.token && document.getElementById('ghToken')) document.getElementById('ghToken').value = cfg.token;
    if (cfg.owner && document.getElementById('ghOwner')) document.getElementById('ghOwner').value = cfg.owner;
    if (cfg.repo  && document.getElementById('ghRepo'))  document.getElementById('ghRepo').value  = cfg.repo;
    if (cfg.path  && document.getElementById('ghPath'))  document.getElementById('ghPath').value  = cfg.path;
    if (document.getElementById('ghAuto')) document.getElementById('ghAuto').checked = !!cfg.auto;
    if (cfg.interval && document.getElementById('ghInterval')) {
  document.getElementById('ghInterval').value = cfg.interval;
}
  } catch(e) {
    console.warn('GitHub é…ç½®è§£æå¤±è´¥ï¼š', e);
  }
}

// GitHub API éœ€è¦ base64 æ–‡æœ¬ï¼Œå¤„ç†ä¸€ä¸‹ä¸­æ–‡
function toBase64(str) {
  return btoa(unescape(encodeURIComponent(str)));
}
function fromBase64(b64) {
  return decodeURIComponent(escape(atob(b64)));
}

// æ‰“ä¸€ä¸ªæ€»å¤‡ä»½å¯¹è±¡ï¼ˆå¯ä»¥ä»¥åæ‰©ï¼‰
function buildBackupObject() {
  return {
    version: 1,
    time: new Date().toISOString(),
    db,
    current
  };
}

// æ‰‹åŠ¨ä¸Šä¼ ä¸€æ¬¡ï¼ˆæŒ‰é’®ç”¨ï¼‰
async function ghUploadBackup(isAuto) {
  const cfg = getGhConfig();
  if (!cfg.token || !cfg.owner || !cfg.repo) {
    if (!isAuto) alert('å…ˆåœ¨ GitHub äº‘å¤‡ä»½é‡Œå¡«å¥½ Token / ä»“åº“ / æ–‡ä»¶å~');
    return;
  }

  saveGhConfig();

  const url = `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${encodeURIComponent(cfg.path)}`;

  const backup = buildBackupObject();
  const text   = JSON.stringify(backup);
  const content = toBase64(text);

  // å…ˆå°è¯•è¯»ä¸€ä¸‹ï¼Œæ‹¿åˆ° shaï¼ˆæ›´æ–°æ–‡ä»¶è¦å¸¦ shaï¼‰
  let sha = undefined;
  try {
    const r0 = await fetch(url, {
      headers: { 'Authorization': `Bearer ${cfg.token}` }
    });
    if (r0.ok) {
      const j = await r0.json();
      sha = j.sha;
    }
  } catch (e) {
    console.warn('è¯»å–æ—§å¤‡ä»½å¤±è´¥ï¼ˆæ²¡å…³ç³»ï¼‰ï¼š', e);
  }

  const body = {
    message: (isAuto ? '[auto]' : '[manual]') + ' Moxie diary backup ' + new Date().toLocaleString(),
    content,
  };
  if (sha) body.sha = sha;

  const resp = await fetch(url, {
    method: 'PUT',
    headers: {
      'Authorization': `Bearer ${cfg.token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  if (!resp.ok) {
    const txt = await resp.text();
    console.error('ä¸Šä¼ å¤±è´¥ï¼š', resp.status, txt);
    if (!isAuto) alert('GitHub ä¸Šä¼ å¤±è´¥ï¼š' + resp.status);
    return;
  }

  ghLastBackup = Date.now();
  if (!isAuto) alert('GitHub å¤‡ä»½æˆåŠŸå•¦ï½');
}

// æ‰‹åŠ¨æ¢å¤ï¼ˆæŒ‰é’®ç”¨ï¼‰
async function ghRestoreBackup() {
  const cfg = getGhConfig();
  if (!cfg.token || !cfg.owner || !cfg.repo) {
    alert('å…ˆåœ¨ GitHub äº‘å¤‡ä»½é‡Œå¡«å¥½ Token / ä»“åº“ / æ–‡ä»¶å~');
    return;
  }

  saveGhConfig();

  const url = `https://api.github.com/repos/${encodeURIComponent(cfg.owner)}/${encodeURIComponent(cfg.repo)}/contents/${encodeURIComponent(cfg.path)}`;

  const resp = await fetch(url, {
    headers: { 'Authorization': `Bearer ${cfg.token}` }
  });

  if (!resp.ok) {
    const txt = await resp.text();
    console.error('ä¸‹è½½å¤±è´¥ï¼š', resp.status, txt);
    alert('GitHub ä¸‹è½½å¤±è´¥ï¼š' + resp.status);
    return;
  }

  const data = await resp.json();
  const text = fromBase64(data.content || '');
  const backup = JSON.parse(text);

  if (!backup || !backup.db) {
    alert('å¤‡ä»½æ–‡ä»¶å†…å®¹ä¸å¯¹ï¼Œæ²¡æ‰¾åˆ° db');
    return;
  }

  db = backup.db;
  if (backup.current) current = backup.current;

  autosave();   // å­˜å›æœ¬åœ°
  render();
  alert('æ¢å¤å®Œæˆå•¦ï¼ˆå·²ç»ç”¨ GitHub å¤‡ä»½è¦†ç›–æœ¬åœ°ï¼‰');
}

// è‡ªåŠ¨å¤‡ä»½ï¼šåŸºäº autosave å»è§¦å‘
function scheduleGhAutoBackup() {
  const cfg = getGhConfig();
  if (!cfg.auto) return; // æ²¡å¼€è‡ªåŠ¨å¤‡ä»½å°±ç›´æ¥è·³è¿‡

  const now = Date.now();
  const gap = ghIntervalMs(cfg.interval || '10m'); // ç”¨ä½ é€‰çš„é¢‘ç‡
  if (now - ghLastBackup < gap) return;

  if (ghAutoTimer) return; // å·²ç»çº¦å¥½ä¸€æ¬¡äº†

  ghAutoTimer = setTimeout(async () => {
    ghAutoTimer = null;
    try {
      await ghUploadBackup(true);
    } catch (e) {
      console.warn('è‡ªåŠ¨ GitHub å¤‡ä»½å¤±è´¥ï¼š', e);
    }
  }, 5000); // åœ 5 ç§’å†ä¼ ï¼Œé¿å…ä½ è¿˜åœ¨ç‹‚æ•²
}
loadGhConfig();
render();

/* ===== å¯åŠ¨ ===== */
render();
</script>
</div></div></body>
</html>